Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id D0B9536677F
	for <lists+qemu-devel@lfdr.de>; Wed, 21 Apr 2021 11:05:42 +0200 (CEST)
Received: from localhost ([::1]:60500 helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>)
	id 1lZ8nl-00089E-N9
	for lists+qemu-devel@lfdr.de; Wed, 21 Apr 2021 05:05:41 -0400
Received: from eggs.gnu.org ([2001:470:142:3::10]:34714)
 by lists.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <peter.maydell@linaro.org>)
 id 1lZ8mM-0007cG-6Y
 for qemu-devel@nongnu.org; Wed, 21 Apr 2021 05:04:14 -0400
Received: from mail-ej1-x631.google.com ([2a00:1450:4864:20::631]:35830)
 by eggs.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.90_1) (envelope-from <peter.maydell@linaro.org>)
 id 1lZ8mG-0003t5-Qf
 for qemu-devel@nongnu.org; Wed, 21 Apr 2021 05:04:13 -0400
Received: by mail-ej1-x631.google.com with SMTP id u17so62451511ejk.2
 for <qemu-devel@nongnu.org>; Wed, 21 Apr 2021 02:04:08 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=mime-version:references:in-reply-to:from:date:message-id:subject:to
 :cc; bh=GKCLAQ2AHxFEX0QQt742+llvescRd/ZEMY+mdYDO/EU=;
 b=XEgQ9Ib9CFptm0qAoL+VSikH9rpUwDq7589KozpXpboIb6X37C/6Rgw2MdicAaVhBa
 6lrb24c5NcA4h44bYpbWS3Igl3ZIUj1jAN5nU1ZX5VcFGQ0TuBkhrL539jDBf9zoqaMz
 XGFcSuF7hop5Q+t03PDAxYT2C4eAPlxU2YaXOdDlSpfp9V+5ZK9E18R0fv6lvaIVELvI
 v1F3U9PV0xutzG052iXtdlvhD7BIqRNNns8Nqwp5z6jXANVrTSU2wd4yP1LD7NF7k/qO
 mv5p+lCixw0QZmtVbatBQnYooTvFJC6LikHKmzPioOfYiKXsFrP6AvpHvd5lLO3GBsCl
 A2lg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:mime-version:references:in-reply-to:from:date
 :message-id:subject:to:cc;
 bh=GKCLAQ2AHxFEX0QQt742+llvescRd/ZEMY+mdYDO/EU=;
 b=Kn/M/aOhN+tCmoeMGXVnyxe5gtCbn87NSl7rUArvtw86exg9KuYTKnps60WvJTXgGi
 YGO/6lDUk0XgALAWvEV+QGSPo/YB8PElScNTXc/WvZQN6lkHeiMn6+kIw8TsayLHfc7h
 hCGAKZnaQ9/Xwcysg5FbVJsB8tPKUJsynpg2jRQkrAhiltZXDLVHD4lFpjxW2HtKwpWe
 RYQcZXrvXMLfT1lgjA2QjlxAjmfSvh1zAU20ptxDabf/wQKWO7XGa0MIOGyplFifm8lA
 ofOC6T3UMGZbxfkbKO/vpWxMJpgF7b+Yo8+mHSbvxF1gfuVbAvjNzEROrIoQ3ih3fy+7
 +CXQ==
X-Gm-Message-State: AOAM533VGAZIL3X7euKJcHJHmJOfR6+vNg2ejaBDXIkmXCLWrzXQwJBz
 DL4FPGF8gXiMMuOEZ0jfvRfJlncDwvbtaaPaav+RRg==
X-Google-Smtp-Source: ABdhPJw9OwUTfjFwLQHrfjCNqfaf+xaVAloHKgp/WLI7kQIisvp0Fqnt0FpNBvAqW1W1Knik+pbZYcarfMYUerxoTW8=
X-Received: by 2002:a17:906:6d41:: with SMTP id
 a1mr24771761ejt.482.1618995846936; 
 Wed, 21 Apr 2021 02:04:06 -0700 (PDT)
MIME-Version: 1.0
References: <YH98WLDMQ5c0Zf5E@humpty.home.comstyle.com>
In-Reply-To: <YH98WLDMQ5c0Zf5E@humpty.home.comstyle.com>
From: Peter Maydell <peter.maydell@linaro.org>
Date: Wed, 21 Apr 2021 10:03:14 +0100
Message-ID: <CAFEAcA995L--csz+fX4MqkSPTPxQ7Nx=q-Lh70bi_zQGoj54mw@mail.gmail.com>
Subject: Re: [PATCH] tcg/ppc: Fix building with Clang
To: Brad Smith <brad@comstyle.com>
Content-Type: text/plain; charset="UTF-8"
Received-SPF: pass client-ip=2a00:1450:4864:20::631;
 envelope-from=peter.maydell@linaro.org; helo=mail-ej1-x631.google.com
X-Spam_score_int: -20
X-Spam_score: -2.1
X-Spam_bar: --
X-Spam_report: (-2.1 / 5.0 requ) BAYES_00=-1.9, DKIM_SIGNED=0.1,
 DKIM_VALID=-0.1, DKIM_VALID_AU=-0.1, DKIM_VALID_EF=-0.1,
 RCVD_IN_DNSWL_NONE=-0.0001, SPF_HELO_NONE=0.001,
 SPF_PASS=-0.001 autolearn=ham autolearn_force=no
X-Spam_action: no action
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Richard Henderson <richard.henderson@linaro.org>,
 QEMU Developers <qemu-devel@nongnu.org>
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>

On Wed, 21 Apr 2021 at 02:15, Brad Smith <brad@comstyle.com> wrote:
>
> Fix building with Clang.
>
> At the moment Clang does not define _CALL_SYSV as GCC does. From
> clang/lib/Basic/Targets/PPC.cpp in getTargetDefines()..
>
>   // FIXME: The following are not yet generated here by Clang, but are
>   //        generated by GCC:
>   //
>   //   _SOFT_FLOAT_
>   //   __RECIP_PRECISION__
>   //   __APPLE_ALTIVEC__
>   //   __RECIP__
>   //   __RECIPF__
>   //   __RSQRTE__
>   //   __RSQRTEF__
>   //   _SOFT_DOUBLE_
>   //   __NO_LWSYNC__
>   //   __CMODEL_MEDIUM__
>   //   __CMODEL_LARGE__
>   //   _CALL_SYSV
>   //   _CALL_DARWIN
>
> This is from the OpenBSD ports tree where we use it to build
> on OpenBSD/powerpc.
>
> Signed-off-by: Brad Smith <brad@comstyle.com>
>
> diff --git a/tcg/ppc/tcg-target.c.inc b/tcg/ppc/tcg-target.c.inc
> index 838ccfa42d..d2611832e5 100644
> --- a/tcg/ppc/tcg-target.c.inc
> +++ b/tcg/ppc/tcg-target.c.inc
> @@ -25,6 +25,11 @@
>  #include "elf.h"
>  #include "../tcg-pool.c.inc"
>
> +/* Clang does not define _CALL_* */
> +#if defined(__clang__) && defined(__ELF__) && !defined(_CALL_SYSV)
> +#define _CALL_SYSV 1
> +#endif

This is trying to identify the calling convention used by the OS.
That's not purely compiler specific (ie it is not the case that
all ELF output from clang is definitely using the calling convention
that _CALL_SYSV implies), so settign it purely based on "this is clang
producing ELF files" doesn't seem right.

I guess if clang doesn't reliably tell us the calling convention
maybe we should scrap the use of _CALL_SYSV and _CALL_ELF and
use the host OS defines to guess the calling convention ?

thanks
-- PMM

