Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id 64123310E58
	for <lists+qemu-devel@lfdr.de>; Fri,  5 Feb 2021 18:11:25 +0100 (CET)
Received: from localhost ([::1]:57090 helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>)
	id 1l84de-0001OE-NG
	for lists+qemu-devel@lfdr.de; Fri, 05 Feb 2021 12:11:22 -0500
Received: from eggs.gnu.org ([2001:470:142:3::10]:43200)
 by lists.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <stefanha@redhat.com>)
 id 1l84IE-0003hy-57
 for qemu-devel@nongnu.org; Fri, 05 Feb 2021 11:49:14 -0500
Received: from us-smtp-delivery-124.mimecast.com ([216.205.24.124]:22111)
 by eggs.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_CBC_SHA1:256)
 (Exim 4.90_1) (envelope-from <stefanha@redhat.com>)
 id 1l84IB-0007P5-K2
 for qemu-devel@nongnu.org; Fri, 05 Feb 2021 11:49:13 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
 s=mimecast20190719; t=1612543748;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=ZPakaozXTp5xm9647QN9viZsZHG4zCXv3GF1H1HQUmU=;
 b=afjW9ZAxGZNWibCmiszd40x0+lQdOrbwI1J4zwTFcJRehkwZNSd3vHeGRuZJeU3zXGuD4/
 bPRWkoH5YRLB8AJm6nZW5Ulye5KqtXfW3ZntFrcz+hEgtBiK8batnQpAR3Qxsz6yUpuUz/
 o9o7U1SrpGS/1u94jsIkaC4Zk8mW5Ns=
Received: from mimecast-mx01.redhat.com (mimecast-mx01.redhat.com
 [209.132.183.4]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-253-t_D0ENVgMgK3SaciU0iJZQ-1; Fri, 05 Feb 2021 11:49:06 -0500
X-MC-Unique: t_D0ENVgMgK3SaciU0iJZQ-1
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
 [10.5.11.14])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mimecast-mx01.redhat.com (Postfix) with ESMTPS id 0FC1E19611A0;
 Fri,  5 Feb 2021 16:49:04 +0000 (UTC)
Received: from localhost (ovpn-112-54.ams2.redhat.com [10.36.112.54])
 by smtp.corp.redhat.com (Postfix) with ESMTP id AD4675D9DB;
 Fri,  5 Feb 2021 16:48:52 +0000 (UTC)
From: Stefan Hajnoczi <stefanha@redhat.com>
To: Peter Maydell <peter.maydell@linaro.org>,
	qemu-devel@nongnu.org
Subject: [PULL v3 21/27] multi-process: Forward PCI config space acceses to
 the remote process
Date: Fri,  5 Feb 2021 16:44:53 +0000
Message-Id: <20210205164459.432714-22-stefanha@redhat.com>
In-Reply-To: <20210205164459.432714-1-stefanha@redhat.com>
References: <20210205164459.432714-1-stefanha@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
Authentication-Results: relay.mimecast.com;
 auth=pass smtp.auth=CUSA124A263 smtp.mailfrom=stefanha@redhat.com
X-Mimecast-Spam-Score: 0
X-Mimecast-Originator: redhat.com
Content-Transfer-Encoding: base64
Content-Type: text/plain; charset="US-ASCII"
Received-SPF: pass client-ip=216.205.24.124; envelope-from=stefanha@redhat.com;
 helo=us-smtp-delivery-124.mimecast.com
X-Spam_score_int: -13
X-Spam_score: -1.4
X-Spam_bar: -
X-Spam_report: (-1.4 / 5.0 requ) BAYES_00=-1.9, DKIMWL_WL_HIGH=-0.352,
 DKIM_SIGNED=0.1, DKIM_VALID=-0.1, DKIM_VALID_AU=-0.1, DKIM_VALID_EF=-0.1,
 MIME_BASE64_TEXT=1.741, RCVD_IN_DNSWL_LOW=-0.7, RCVD_IN_MSPIKE_H3=0.001,
 RCVD_IN_MSPIKE_WL=0.001, SPF_HELO_NONE=0.001,
 SPF_PASS=-0.001 autolearn=unavailable autolearn_force=no
X-Spam_action: no action
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Fam Zheng <fam@euphon.net>, John G Johnson <john.g.johnson@oracle.com>,
 Thomas Huth <thuth@redhat.com>, Jagannathan Raman <jag.raman@oracle.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, qemu-block@nongnu.org,
 "Michael S. Tsirkin" <mst@redhat.com>, "Denis V. Lunev" <den@openvz.org>,
 =?UTF-8?q?Philippe=20Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 =?UTF-8?q?Daniel=20P=2E=20Berrang=C3=A9?= <berrange@redhat.com>,
 Elena Ufimtseva <elena.ufimtseva@oracle.com>,
 Wainer dos Santos Moschetta <wainersm@redhat.com>,
 Igor Mammedov <imammedo@redhat.com>, Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Alex=20Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Eduardo Habkost <ehabkost@redhat.com>
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>

RnJvbTogRWxlbmEgVWZpbXRzZXZhIDxlbGVuYS51ZmltdHNldmFAb3JhY2xlLmNvbT4KClRoZSBQ
cm94eSBPYmplY3Qgc2VuZHMgdGhlIFBDSSBjb25maWcgc3BhY2UgYWNjZXNzZXMgYXMgbWVzc2Fn
ZXMKdG8gdGhlIHJlbW90ZSBwcm9jZXNzIG92ZXIgdGhlIGNvbW11bmljYXRpb24gY2hhbm5lbAoK
U2lnbmVkLW9mZi1ieTogRWxlbmEgVWZpbXRzZXZhIDxlbGVuYS51ZmltdHNldmFAb3JhY2xlLmNv
bT4KU2lnbmVkLW9mZi1ieTogSmFnYW5uYXRoYW4gUmFtYW4gPGphZy5yYW1hbkBvcmFjbGUuY29t
PgpTaWduZWQtb2ZmLWJ5OiBKb2huIEcgSm9obnNvbiA8am9obi5nLmpvaG5zb25Ab3JhY2xlLmNv
bT4KUmV2aWV3ZWQtYnk6IFN0ZWZhbiBIYWpub2N6aSA8c3RlZmFuaGFAcmVkaGF0LmNvbT4KTWVz
c2FnZS1pZDogZDNjOTRmNDYxODgxMzIzNDY1NTM1NmM2MGU2ZjBkMDM2MmZmNDJkNi4xNjExOTM4
MzE5LmdpdC5qYWcucmFtYW5Ab3JhY2xlLmNvbQpTaWduZWQtb2ZmLWJ5OiBTdGVmYW4gSGFqbm9j
emkgPHN0ZWZhbmhhQHJlZGhhdC5jb20+Ci0tLQogaW5jbHVkZS9ody9yZW1vdGUvbXBxZW11LWxp
bmsuaCB8IDEwICsrKysrKwogaHcvcmVtb3RlL21lc3NhZ2UuYyAgICAgICAgICAgICB8IDYwICsr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKwogaHcvcmVtb3RlL21wcWVtdS1saW5rLmMg
ICAgICAgICB8ICA4ICsrKystCiBody9yZW1vdGUvcHJveHkuYyAgICAgICAgICAgICAgIHwgNTUg
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrCiA0IGZpbGVzIGNoYW5nZWQsIDEzMiBpbnNl
cnRpb25zKCspLCAxIGRlbGV0aW9uKC0pCgpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9ody9yZW1vdGUv
bXBxZW11LWxpbmsuaCBiL2luY2x1ZGUvaHcvcmVtb3RlL21wcWVtdS1saW5rLmgKaW5kZXggMWIz
NWQ0MDhmOC4uN2JjMGJkZGI1YSAxMDA2NDQKLS0tIGEvaW5jbHVkZS9ody9yZW1vdGUvbXBxZW11
LWxpbmsuaAorKysgYi9pbmNsdWRlL2h3L3JlbW90ZS9tcHFlbXUtbGluay5oCkBAIC0zNCw2ICsz
NCw5IEBACiAgKi8KIHR5cGVkZWYgZW51bSB7CiAgICAgTVBRRU1VX0NNRF9TWU5DX1NZU01FTSwK
KyAgICBNUFFFTVVfQ01EX1JFVCwKKyAgICBNUFFFTVVfQ01EX1BDSV9DRkdXUklURSwKKyAgICBN
UFFFTVVfQ01EX1BDSV9DRkdSRUFELAogICAgIE1QUUVNVV9DTURfTUFYLAogfSBNUFFlbXVDbWQ7
CiAKQEAgLTQzLDYgKzQ2LDEyIEBAIHR5cGVkZWYgc3RydWN0IHsKICAgICBvZmZfdCBvZmZzZXRz
W1JFTU9URV9NQVhfRkRTXTsKIH0gU3luY1N5c21lbU1zZzsKIAordHlwZWRlZiBzdHJ1Y3Qgewor
ICAgIHVpbnQzMl90IGFkZHI7CisgICAgdWludDMyX3QgdmFsOworICAgIGludCBsZW47Cit9IFBj
aUNvbmZEYXRhTXNnOworCiAvKioKICAqIE1QUWVtdU1zZzoKICAqIEBjbWQ6IFRoZSByZW1vdGUg
Y29tbWFuZApAQCAtNjAsNiArNjksNyBAQCB0eXBlZGVmIHN0cnVjdCB7CiAKICAgICB1bmlvbiB7
CiAgICAgICAgIHVpbnQ2NF90IHU2NDsKKyAgICAgICAgUGNpQ29uZkRhdGFNc2cgcGNpX2NvbmZf
ZGF0YTsKICAgICAgICAgU3luY1N5c21lbU1zZyBzeW5jX3N5c21lbTsKICAgICB9IGRhdGE7CiAK
ZGlmZiAtLWdpdCBhL2h3L3JlbW90ZS9tZXNzYWdlLmMgYi9ody9yZW1vdGUvbWVzc2FnZS5jCmlu
ZGV4IDM2ZTJkNGZiMGMuLjYzNmJkMTYxYmQgMTAwNjQ0Ci0tLSBhL2h3L3JlbW90ZS9tZXNzYWdl
LmMKKysrIGIvaHcvcmVtb3RlL21lc3NhZ2UuYwpAQCAtMTUsNiArMTUsMTIgQEAKICNpbmNsdWRl
ICJody9yZW1vdGUvbXBxZW11LWxpbmsuaCIKICNpbmNsdWRlICJxYXBpL2Vycm9yLmgiCiAjaW5j
bHVkZSAic3lzZW11L3J1bnN0YXRlLmgiCisjaW5jbHVkZSAiaHcvcGNpL3BjaS5oIgorCitzdGF0
aWMgdm9pZCBwcm9jZXNzX2NvbmZpZ193cml0ZShRSU9DaGFubmVsICppb2MsIFBDSURldmljZSAq
ZGV2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTVBRZW11TXNnICptc2csIEVy
cm9yICoqZXJycCk7CitzdGF0aWMgdm9pZCBwcm9jZXNzX2NvbmZpZ19yZWFkKFFJT0NoYW5uZWwg
KmlvYywgUENJRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1Q
UWVtdU1zZyAqbXNnLCBFcnJvciAqKmVycnApOwogCiB2b2lkIGNvcm91dGluZV9mbiBtcHFlbXVf
cmVtb3RlX21zZ19sb29wX2NvKHZvaWQgKmRhdGEpCiB7CkBAIC00MCw2ICs0NiwxMiBAQCB2b2lk
IGNvcm91dGluZV9mbiBtcHFlbXVfcmVtb3RlX21zZ19sb29wX2NvKHZvaWQgKmRhdGEpCiAgICAg
ICAgIH0KIAogICAgICAgICBzd2l0Y2ggKG1zZy5jbWQpIHsKKyAgICAgICAgY2FzZSBNUFFFTVVf
Q01EX1BDSV9DRkdXUklURToKKyAgICAgICAgICAgIHByb2Nlc3NfY29uZmlnX3dyaXRlKGNvbS0+
aW9jLCBwY2lfZGV2LCAmbXNnLCAmbG9jYWxfZXJyKTsKKyAgICAgICAgICAgIGJyZWFrOworICAg
ICAgICBjYXNlIE1QUUVNVV9DTURfUENJX0NGR1JFQUQ6CisgICAgICAgICAgICBwcm9jZXNzX2Nv
bmZpZ19yZWFkKGNvbS0+aW9jLCBwY2lfZGV2LCAmbXNnLCAmbG9jYWxfZXJyKTsKKyAgICAgICAg
ICAgIGJyZWFrOwogICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgZXJyb3Jfc2V0ZygmbG9j
YWxfZXJyLAogICAgICAgICAgICAgICAgICAgICAgICAiVW5rbm93biBjb21tYW5kICglZCkgcmVj
ZWl2ZWQgZm9yIGRldmljZSAlcyIKQEAgLTU1LDMgKzY3LDUxIEBAIHZvaWQgY29yb3V0aW5lX2Zu
IG1wcWVtdV9yZW1vdGVfbXNnX2xvb3BfY28odm9pZCAqZGF0YSkKICAgICAgICAgcWVtdV9zeXN0
ZW1fc2h1dGRvd25fcmVxdWVzdChTSFVURE9XTl9DQVVTRV9HVUVTVF9TSFVURE9XTik7CiAgICAg
fQogfQorCitzdGF0aWMgdm9pZCBwcm9jZXNzX2NvbmZpZ193cml0ZShRSU9DaGFubmVsICppb2Ms
IFBDSURldmljZSAqZGV2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTVBRZW11
TXNnICptc2csIEVycm9yICoqZXJycCkKK3sKKyAgICBFUlJQX0dVQVJEKCk7CisgICAgUGNpQ29u
ZkRhdGFNc2cgKmNvbmYgPSAoUGNpQ29uZkRhdGFNc2cgKikmbXNnLT5kYXRhLnBjaV9jb25mX2Rh
dGE7CisgICAgTVBRZW11TXNnIHJldCA9IHsgMCB9OworCisgICAgaWYgKChjb25mLT5hZGRyICsg
c2l6ZW9mKGNvbmYtPnZhbCkpID4gcGNpX2NvbmZpZ19zaXplKGRldikpIHsKKyAgICAgICAgZXJy
b3Jfc2V0ZyhlcnJwLCAiQmFkIGFkZHJlc3MgZm9yIFBDSSBjb25maWcgd3JpdGUsIHBpZCAiRk1U
X3BpZCIuIiwKKyAgICAgICAgICAgICAgICAgICBnZXRwaWQoKSk7CisgICAgICAgIHJldC5kYXRh
LnU2NCA9IFVJTlQ2NF9NQVg7CisgICAgfSBlbHNlIHsKKyAgICAgICAgcGNpX2RlZmF1bHRfd3Jp
dGVfY29uZmlnKGRldiwgY29uZi0+YWRkciwgY29uZi0+dmFsLCBjb25mLT5sZW4pOworICAgIH0K
KworICAgIHJldC5jbWQgPSBNUFFFTVVfQ01EX1JFVDsKKyAgICByZXQuc2l6ZSA9IHNpemVvZihy
ZXQuZGF0YS51NjQpOworCisgICAgaWYgKCFtcHFlbXVfbXNnX3NlbmQoJnJldCwgaW9jLCBOVUxM
KSkgeworICAgICAgICBlcnJvcl9wcmVwZW5kKGVycnAsICJFcnJvciByZXR1cm5pbmcgY29kZSB0
byBwcm94eSwgcGlkICJGTVRfcGlkIjogIiwKKyAgICAgICAgICAgICAgICAgICAgICBnZXRwaWQo
KSk7CisgICAgfQorfQorCitzdGF0aWMgdm9pZCBwcm9jZXNzX2NvbmZpZ19yZWFkKFFJT0NoYW5u
ZWwgKmlvYywgUENJRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IE1QUWVtdU1zZyAqbXNnLCBFcnJvciAqKmVycnApCit7CisgICAgRVJSUF9HVUFSRCgpOworICAg
IFBjaUNvbmZEYXRhTXNnICpjb25mID0gKFBjaUNvbmZEYXRhTXNnICopJm1zZy0+ZGF0YS5wY2lf
Y29uZl9kYXRhOworICAgIE1QUWVtdU1zZyByZXQgPSB7IDAgfTsKKworICAgIGlmICgoY29uZi0+
YWRkciArIHNpemVvZihjb25mLT52YWwpKSA+IHBjaV9jb25maWdfc2l6ZShkZXYpKSB7CisgICAg
ICAgIGVycm9yX3NldGcoZXJycCwgIkJhZCBhZGRyZXNzIGZvciBQQ0kgY29uZmlnIHJlYWQsIHBp
ZCAiRk1UX3BpZCIuIiwKKyAgICAgICAgICAgICAgICAgICBnZXRwaWQoKSk7CisgICAgICAgIHJl
dC5kYXRhLnU2NCA9IFVJTlQ2NF9NQVg7CisgICAgfSBlbHNlIHsKKyAgICAgICAgcmV0LmRhdGEu
dTY0ID0gcGNpX2RlZmF1bHRfcmVhZF9jb25maWcoZGV2LCBjb25mLT5hZGRyLCBjb25mLT5sZW4p
OworICAgIH0KKworICAgIHJldC5jbWQgPSBNUFFFTVVfQ01EX1JFVDsKKyAgICByZXQuc2l6ZSA9
IHNpemVvZihyZXQuZGF0YS51NjQpOworCisgICAgaWYgKCFtcHFlbXVfbXNnX3NlbmQoJnJldCwg
aW9jLCBOVUxMKSkgeworICAgICAgICBlcnJvcl9wcmVwZW5kKGVycnAsICJFcnJvciByZXR1cm5p
bmcgY29kZSB0byBwcm94eSwgcGlkICJGTVRfcGlkIjogIiwKKyAgICAgICAgICAgICAgICAgICAg
ICBnZXRwaWQoKSk7CisgICAgfQorfQpkaWZmIC0tZ2l0IGEvaHcvcmVtb3RlL21wcWVtdS1saW5r
LmMgYi9ody9yZW1vdGUvbXBxZW11LWxpbmsuYwppbmRleCBmNWU5ZTAxOTIzLi5iNDVmMzI1Njg2
IDEwMDY0NAotLS0gYS9ody9yZW1vdGUvbXBxZW11LWxpbmsuYworKysgYi9ody9yZW1vdGUvbXBx
ZW11LWxpbmsuYwpAQCAtMjA3LDcgKzIwNyw3IEBAIHVpbnQ2NF90IG1wcWVtdV9tc2dfc2VuZF9h
bmRfYXdhaXRfcmVwbHkoTVBRZW11TXNnICptc2csIFBDSVByb3h5RGV2ICpwZGV2LAogICAgICAg
ICByZXR1cm4gcmV0OwogICAgIH0KIAotICAgIGlmICghbXBxZW11X21zZ192YWxpZCgmbXNnX3Jl
cGx5KSkgeworICAgIGlmICghbXBxZW11X21zZ192YWxpZCgmbXNnX3JlcGx5KSB8fCBtc2dfcmVw
bHkuY21kICE9IE1QUUVNVV9DTURfUkVUKSB7CiAgICAgICAgIGVycm9yX3NldGcoZXJycCwgIkVS
Uk9SOiBJbnZhbGlkIHJlcGx5IHJlY2VpdmVkIGZvciBjb21tYW5kICVkIiwKICAgICAgICAgICAg
ICAgICAgICAgICAgICBtc2ctPmNtZCk7CiAgICAgICAgIHJldHVybiByZXQ7CkBAIC0yNDIsNiAr
MjQyLDEyIEBAIGJvb2wgbXBxZW11X21zZ192YWxpZChNUFFlbXVNc2cgKm1zZykKICAgICAgICAg
ICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgfQogICAgICAgICBicmVhazsKKyAgICBjYXNlIE1Q
UUVNVV9DTURfUENJX0NGR1dSSVRFOgorICAgIGNhc2UgTVBRRU1VX0NNRF9QQ0lfQ0ZHUkVBRDoK
KyAgICAgICAgaWYgKG1zZy0+c2l6ZSAhPSBzaXplb2YoUGNpQ29uZkRhdGFNc2cpKSB7CisgICAg
ICAgICAgICByZXR1cm4gZmFsc2U7CisgICAgICAgIH0KKyAgICAgICAgYnJlYWs7CiAgICAgZGVm
YXVsdDoKICAgICAgICAgYnJlYWs7CiAgICAgfQpkaWZmIC0tZ2l0IGEvaHcvcmVtb3RlL3Byb3h5
LmMgYi9ody9yZW1vdGUvcHJveHkuYwppbmRleCBjZDViMDcxYWI0Li4yYjE0Mzk0MzJiIDEwMDY0
NAotLS0gYS9ody9yZW1vdGUvcHJveHkuYworKysgYi9ody9yZW1vdGUvcHJveHkuYwpAQCAtMTcs
NiArMTcsOCBAQAogI2luY2x1ZGUgIm1vbml0b3IvbW9uaXRvci5oIgogI2luY2x1ZGUgIm1pZ3Jh
dGlvbi9ibG9ja2VyLmgiCiAjaW5jbHVkZSAicWVtdS9zb2NrZXRzLmgiCisjaW5jbHVkZSAiaHcv
cmVtb3RlL21wcWVtdS1saW5rLmgiCisjaW5jbHVkZSAicWVtdS9lcnJvci1yZXBvcnQuaCIKIAog
c3RhdGljIHZvaWQgcGNpX3Byb3h5X2Rldl9yZWFsaXplKFBDSURldmljZSAqZGV2aWNlLCBFcnJv
ciAqKmVycnApCiB7CkBAIC02NSw2ICs2Nyw1NiBAQCBzdGF0aWMgdm9pZCBwY2lfcHJveHlfZGV2
X2V4aXQoUENJRGV2aWNlICpwZGV2KQogICAgIGVycm9yX2ZyZWUoZGV2LT5taWdyYXRpb25fYmxv
Y2tlcik7CiB9CiAKK3N0YXRpYyB2b2lkIGNvbmZpZ19vcF9zZW5kKFBDSVByb3h5RGV2ICpwZGV2
LCB1aW50MzJfdCBhZGRyLCB1aW50MzJfdCAqdmFsLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgaW50IGxlbiwgdW5zaWduZWQgaW50IG9wKQoreworICAgIE1QUWVtdU1zZyBtc2cgPSB7IDAg
fTsKKyAgICB1aW50NjRfdCByZXQgPSAtRUlOVkFMOworICAgIEVycm9yICpsb2NhbF9lcnIgPSBO
VUxMOworCisgICAgbXNnLmNtZCA9IG9wOworICAgIG1zZy5kYXRhLnBjaV9jb25mX2RhdGEuYWRk
ciA9IGFkZHI7CisgICAgbXNnLmRhdGEucGNpX2NvbmZfZGF0YS52YWwgPSAob3AgPT0gTVBRRU1V
X0NNRF9QQ0lfQ0ZHV1JJVEUpID8gKnZhbCA6IDA7CisgICAgbXNnLmRhdGEucGNpX2NvbmZfZGF0
YS5sZW4gPSBsZW47CisgICAgbXNnLnNpemUgPSBzaXplb2YoUGNpQ29uZkRhdGFNc2cpOworCisg
ICAgcmV0ID0gbXBxZW11X21zZ19zZW5kX2FuZF9hd2FpdF9yZXBseSgmbXNnLCBwZGV2LCAmbG9j
YWxfZXJyKTsKKyAgICBpZiAobG9jYWxfZXJyKSB7CisgICAgICAgIGVycm9yX3JlcG9ydF9lcnIo
bG9jYWxfZXJyKTsKKyAgICB9CisKKyAgICBpZiAocmV0ID09IFVJTlQ2NF9NQVgpIHsKKyAgICAg
ICAgZXJyb3JfcmVwb3J0KCJGYWlsZWQgdG8gcGVyZm9ybSBQQ0kgY29uZmlnICVzIG9wZXJhdGlv
biIsCisgICAgICAgICAgICAgICAgICAgICAob3AgPT0gTVBRRU1VX0NNRF9QQ0lfQ0ZHUkVBRCkg
PyAiUkVBRCIgOiAiV1JJVEUiKTsKKyAgICB9CisKKyAgICBpZiAob3AgPT0gTVBRRU1VX0NNRF9Q
Q0lfQ0ZHUkVBRCkgeworICAgICAgICAqdmFsID0gKHVpbnQzMl90KXJldDsKKyAgICB9Cit9CisK
K3N0YXRpYyB1aW50MzJfdCBwY2lfcHJveHlfcmVhZF9jb25maWcoUENJRGV2aWNlICpkLCB1aW50
MzJfdCBhZGRyLCBpbnQgbGVuKQoreworICAgIHVpbnQzMl90IHZhbDsKKworICAgIGNvbmZpZ19v
cF9zZW5kKFBDSV9QUk9YWV9ERVYoZCksIGFkZHIsICZ2YWwsIGxlbiwgTVBRRU1VX0NNRF9QQ0lf
Q0ZHUkVBRCk7CisKKyAgICByZXR1cm4gdmFsOworfQorCitzdGF0aWMgdm9pZCBwY2lfcHJveHlf
d3JpdGVfY29uZmlnKFBDSURldmljZSAqZCwgdWludDMyX3QgYWRkciwgdWludDMyX3QgdmFsLAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgbGVuKQoreworICAgIC8qCisg
ICAgICogU29tZSBvZiB0aGUgZnVuY3Rpb25zIGFjY2VzcyB0aGUgY29weSBvZiByZW1vdGUgZGV2
aWNlJ3MgUENJIGNvbmZpZworICAgICAqIHNwYWNlIHdoaWNoIGlzIGNhY2hlZCBpbiB0aGUgcHJv
eHkgZGV2aWNlLiBUaGVyZWZvcmUsIG1haW50YWluCisgICAgICogaXQgdXBkYXRlZC4KKyAgICAg
Ki8KKyAgICBwY2lfZGVmYXVsdF93cml0ZV9jb25maWcoZCwgYWRkciwgdmFsLCBsZW4pOworCisg
ICAgY29uZmlnX29wX3NlbmQoUENJX1BST1hZX0RFVihkKSwgYWRkciwgJnZhbCwgbGVuLCBNUFFF
TVVfQ01EX1BDSV9DRkdXUklURSk7Cit9CisKIHN0YXRpYyBQcm9wZXJ0eSBwcm94eV9wcm9wZXJ0
aWVzW10gPSB7CiAgICAgREVGSU5FX1BST1BfU1RSSU5HKCJmZCIsIFBDSVByb3h5RGV2LCBmZCks
CiAgICAgREVGSU5FX1BST1BfRU5EX09GX0xJU1QoKSwKQEAgLTc3LDYgKzEyOSw5IEBAIHN0YXRp
YyB2b2lkIHBjaV9wcm94eV9kZXZfY2xhc3NfaW5pdChPYmplY3RDbGFzcyAqa2xhc3MsIHZvaWQg
KmRhdGEpCiAKICAgICBrLT5yZWFsaXplID0gcGNpX3Byb3h5X2Rldl9yZWFsaXplOwogICAgIGst
PmV4aXQgPSBwY2lfcHJveHlfZGV2X2V4aXQ7CisgICAgay0+Y29uZmlnX3JlYWQgPSBwY2lfcHJv
eHlfcmVhZF9jb25maWc7CisgICAgay0+Y29uZmlnX3dyaXRlID0gcGNpX3Byb3h5X3dyaXRlX2Nv
bmZpZzsKKwogICAgIGRldmljZV9jbGFzc19zZXRfcHJvcHMoZGMsIHByb3h5X3Byb3BlcnRpZXMp
OwogfQogCi0tIAoyLjI5LjIKCg==


