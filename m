Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id E475C140FC
	for <lists+qemu-devel@lfdr.de>; Sun,  5 May 2019 18:09:47 +0200 (CEST)
Received: from localhost ([127.0.0.1]:43228 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>)
	id 1hNJhz-0004aK-1h
	for lists+qemu-devel@lfdr.de; Sun, 05 May 2019 12:09:47 -0400
Received: from eggs.gnu.org ([209.51.188.92]:53370)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <ysato@users.sourceforge.jp>) id 1hNJfD-0003FT-Gv
	for qemu-devel@nongnu.org; Sun, 05 May 2019 12:06:57 -0400
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <ysato@users.sourceforge.jp>) id 1hNJfC-0006HA-0b
	for qemu-devel@nongnu.org; Sun, 05 May 2019 12:06:55 -0400
Received: from mail02.asahi-net.or.jp ([202.224.55.14]:52073)
	by eggs.gnu.org with esmtp (Exim 4.71)
	(envelope-from <ysato@users.sourceforge.jp>) id 1hNJfB-0006EZ-OL
	for qemu-devel@nongnu.org; Sun, 05 May 2019 12:06:53 -0400
Received: from h61-195-96-97.vps.ablenet.jp (h61-195-96-97.vps.ablenet.jp
	[61.195.96.97]) (Authenticated sender: PQ4Y-STU)
	by mail02.asahi-net.or.jp (Postfix) with ESMTPA id 384BA3ACC3;
	Mon,  6 May 2019 01:06:48 +0900 (JST)
Received: from yo-satoh-debian.ysato.ml (ZM005235.ppp.dion.ne.jp [222.8.5.235])
	by h61-195-96-97.vps.ablenet.jp (Postfix) with ESMTPSA id 84383240085; 
	Mon,  6 May 2019 01:06:47 +0900 (JST)
Date: Mon, 06 May 2019 01:06:42 +0900
Message-ID: <87tve851il.wl-ysato@users.sourceforge.jp>
From: Yoshinori Sato <ysato@users.sourceforge.jp>
To: Alex =?ISO-8859-1?Q?Benn=E9e?= <alex.bennee@linaro.org>
In-Reply-To: <87ftpv4j57.fsf@zen.linaroharston>
References: <20190502143409.59600-1-ysato@users.sourceforge.jp>	<20190502143409.59600-6-ysato@users.sourceforge.jp>	<87ftpv4j57.fsf@zen.linaroharston>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
	FLIM/1.14.9 (=?ISO-8859-4?Q?Goj=F2?=) APEL/10.8 EasyPG/1.0.0 Emacs/25.1
	(x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 202.224.55.14
Subject: Re: [Qemu-devel] [PATCH RFC v8 05/12] target/rx: Miscellaneous files
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: peter.maydell@linaro.org, richard.henderson@linaro.org,
	qemu-devel@nongnu.org
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>

On Sat, 04 May 2019 01:06:44 +0900,
Alex Benn=E9e wrote:
>=20
>=20
> Yoshinori Sato <ysato@users.sourceforge.jp> writes:
>=20
> > Signed-off-by: Yoshinori Sato <ysato@users.sourceforge.jp>
> > ---
> >  target/rx/gdbstub.c     | 112 ++++++++++++++++++++++++++++++++++++++++=
++++++++
> >  target/rx/monitor.c     |  38 ++++++++++++++++
> >  target/rx/Makefile.objs |  11 +++++
> >  3 files changed, 161 insertions(+)
> >  create mode 100644 target/rx/gdbstub.c
> >  create mode 100644 target/rx/monitor.c
> >  create mode 100644 target/rx/Makefile.objs
> >
> > diff --git a/target/rx/gdbstub.c b/target/rx/gdbstub.c
> > new file mode 100644
> > index 0000000000..d76ca52e82
> > --- /dev/null
> > +++ b/target/rx/gdbstub.c
> > @@ -0,0 +1,112 @@
> > +/*
> > + * RX gdb server stub
> > + *
> > + * Copyright (c) 2019 Yoshinori Sato
> > + *
> > + * This program is free software; you can redistribute it and/or modif=
y it
> > + * under the terms and conditions of the GNU General Public License,
> > + * version 2 or later, as published by the Free Software Foundation.
> > + *
> > + * This program is distributed in the hope it will be useful, but WITH=
OUT
> > + * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY =
or
> > + * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public Licen=
se for
> > + * more details.
> > + *
> > + * You should have received a copy of the GNU General Public License a=
long with
> > + * this program.  If not, see <http://www.gnu.org/licenses/>.
> > + */
> > +#include "qemu/osdep.h"
> > +#include "qemu-common.h"
> > +#include "cpu.h"
> > +#include "exec/gdbstub.h"
> > +
> > +int rx_cpu_gdb_read_register(CPUState *cs, uint8_t *mem_buf, int n)
> > +{
> > +    RXCPU *cpu =3D RXCPU(cs);
> > +    CPURXState *env =3D &cpu->env;
> > +
> > +    switch (n) {
> > +    case 0 ... 15:
> > +        return gdb_get_regl(mem_buf, env->regs[n]);
> > +    case 16:
> > +        return gdb_get_regl(mem_buf, (env->psw_u) ? env->regs[0] : env=
->usp);
> > +    case 17:
> > +        return gdb_get_regl(mem_buf, (!env->psw_u) ? env->regs[0] : en=
v->isp);
> > +    case 18:
> > +        return gdb_get_regl(mem_buf, rx_cpu_pack_psw(env));
> > +    case 19:
> > +        return gdb_get_regl(mem_buf, env->pc);
> > +    case 20:
> > +        return gdb_get_regl(mem_buf, env->intb);
> > +    case 21:
> > +        return gdb_get_regl(mem_buf, env->bpsw);
> > +    case 22:
> > +        return gdb_get_regl(mem_buf, env->bpc);
> > +    case 23:
> > +        return gdb_get_regl(mem_buf, env->fintv);
> > +    case 24:
> > +        return gdb_get_regl(mem_buf, env->fpsw);
> > +    case 25:
> > +        return 0;
> > +    }
> > +    return 0;
> > +}
> > +
> > +int rx_cpu_gdb_write_register(CPUState *cs, uint8_t *mem_buf, int n)
> > +{
> > +    RXCPU *cpu =3D RXCPU(cs);
> > +    CPURXState *env =3D &cpu->env;
> > +    uint32_t psw;
> > +    switch (n) {
> > +    case 0 ... 15:
> > +        env->regs[n] =3D ldl_p(mem_buf);
> > +        if (n =3D=3D 0) {
> > +            if (env->psw_u) {
> > +                env->usp =3D env->regs[0];
> > +            } else {
> > +                env->isp =3D env->regs[0];
> > +            }
> > +        }
> > +        break;
> > +    case 16:
> > +        env->usp =3D ldl_p(mem_buf);
> > +        if (env->psw_u) {
> > +            env->regs[0] =3D ldl_p(mem_buf);
> > +        }
> > +        break;
> > +    case 17:
> > +        env->isp =3D ldl_p(mem_buf);
> > +        if (!env->psw_u) {
> > +            env->regs[0] =3D ldl_p(mem_buf);
> > +        }
> > +        break;
> > +    case 18:
> > +        psw =3D ldl_p(mem_buf);
> > +        rx_cpu_unpack_psw(env, psw, 1);
> > +        break;
> > +    case 19:
> > +        env->pc =3D ldl_p(mem_buf);
> > +        break;
> > +    case 20:
> > +        env->intb =3D ldl_p(mem_buf);
> > +        break;
> > +    case 21:
> > +        env->bpsw =3D ldl_p(mem_buf);
> > +        break;
> > +    case 22:
> > +        env->bpc =3D ldl_p(mem_buf);
> > +        break;
> > +    case 23:
> > +        env->fintv =3D ldl_p(mem_buf);
> > +        break;
> > +    case 24:
> > +        env->fpsw =3D ldl_p(mem_buf);
> > +        break;
> > +    case 25:
> > +        return 8;
> > +    default:
> > +        return 0;
> > +    }
> > +
> > +    return 4;
> > +}
> > diff --git a/target/rx/monitor.c b/target/rx/monitor.c
> > new file mode 100644
> > index 0000000000..5d7a1e58b5
> > --- /dev/null
> > +++ b/target/rx/monitor.c
> > @@ -0,0 +1,38 @@
> > +/*
> > + * QEMU monitor
> > + *
> > + * Copyright (c) 2003-2004 Fabrice Bellard
> > + *
> > + * Permission is hereby granted, free of charge, to any person obtaini=
ng a copy
> > + * of this software and associated documentation files (the "Software"=
), to deal
> > + * in the Software without restriction, including without limitation t=
he rights
> > + * to use, copy, modify, merge, publish, distribute, sublicense, and/o=
r sell
> > + * copies of the Software, and to permit persons to whom the Software =
is
> > + * furnished to do so, subject to the following conditions:
> > + *
> > + * The above copyright notice and this permission notice shall be incl=
uded in
> > + * all copies or substantial portions of the Software.
> > + *
> > + * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXP=
RESS OR
> > + * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABI=
LITY,
> > + * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT S=
HALL
> > + * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES O=
R OTHER
> > + * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARI=
SING FROM,
> > + * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALI=
NGS IN
> > + * THE SOFTWARE.
> > + */
> > +#include "qemu/osdep.h"
> > +#include "cpu.h"
> > +#include "monitor/monitor.h"
> > +#include "monitor/hmp-target.h"
> > +#include "hmp.h"
> > +
> > +void hmp_info_tlb(Monitor *mon, const QDict *qdict)
> > +{
> > +    CPUArchState *env =3D mon_get_cpu_env();
> > +
> > +    if (!env) {
> > +        monitor_printf(mon, "No CPU available\n");
> > +        return;
> > +    }
> > +}
> > diff --git a/target/rx/Makefile.objs b/target/rx/Makefile.objs
> > new file mode 100644
> > index 0000000000..f63e1ca43f
> > --- /dev/null
> > +++ b/target/rx/Makefile.objs
> > @@ -0,0 +1,11 @@
> > +obj-y +=3D translate.o op_helper.o helper.o cpu.o gdbstub.o disas.o
> > +obj-$(CONFIG_SOFTMMU) +=3D monitor.o
> > +
> > +DECODETREE =3D $(SRC_PATH)/scripts/decodetree.py
> > +
> > +target/rx/decode.inc.c: \
> > +  $(SRC_PATH)/target/rx/insns.decode $(DECODETREE)
> > +	$(call quiet-command,\
> > +	  $(PYTHON) $(DECODETREE) --varinsnwidth 32 -o $@ $<, "GEN",
> > $(TARGET_DIR)$@)
>=20
> This doesn't work for me:
>=20
>   GEN     rx-softmmu/target/rx/decode.inc.c
> error: (GetoptError('option --varinsnwidth not recognized', 'varinsnwidth=
'),)
>=20
> So are you decode.inc.c stale from some work in progress version of
> decodetree?

Yes.
You need decodetree.py with variable-length ISA support.

https://patchwork.kernel.org/patch/10791503/
https://patchwork.kernel.org/patch/10836503/

> Also this stanza will be need to be introduced in patch 04 as the
> disassembler needs its files.
>=20
> > +
> > +target/rx/translate.o: target/rx/decode.inc.c
>

OK.

>=20
> --
> Alex Benn=E9e
>=20

--=20
Yosinori Sato

