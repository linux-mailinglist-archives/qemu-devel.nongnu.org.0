Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id 1BDC6B8131
	for <lists+qemu-devel@lfdr.de>; Thu, 19 Sep 2019 21:09:16 +0200 (CEST)
Received: from localhost ([::1]:47962 helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>)
	id 1iB1nn-0004xi-82
	for lists+qemu-devel@lfdr.de; Thu, 19 Sep 2019 15:09:15 -0400
Received: from eggs.gnu.org ([2001:470:142:3::10]:38526)
 by lists.gnu.org with esmtp (Exim 4.90_1)
 (envelope-from <lersek@redhat.com>) id 1iB1mp-0004Op-Se
 for qemu-devel@nongnu.org; Thu, 19 Sep 2019 15:08:17 -0400
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
 (envelope-from <lersek@redhat.com>) id 1iB1mo-0003ws-M9
 for qemu-devel@nongnu.org; Thu, 19 Sep 2019 15:08:15 -0400
Received: from mx1.redhat.com ([209.132.183.28]:35726)
 by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
 (Exim 4.71) (envelope-from <lersek@redhat.com>) id 1iB1mo-0003we-Eo
 for qemu-devel@nongnu.org; Thu, 19 Sep 2019 15:08:14 -0400
Received: from smtp.corp.redhat.com (int-mx03.intmail.prod.int.phx2.redhat.com
 [10.5.11.13])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id B222A18CB8EF
 for <qemu-devel@nongnu.org>; Thu, 19 Sep 2019 19:08:13 +0000 (UTC)
Received: from lacos-laptop-7.usersys.redhat.com (ovpn-121-45.rdu2.redhat.com
 [10.10.121.45])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 60F1660872;
 Thu, 19 Sep 2019 19:08:07 +0000 (UTC)
Subject: Re: [PATCH] edk2 build scripts: work around TianoCore#1607 without
 forcing Python 2
To: =?UTF-8?Q?Philippe_Mathieu-Daud=c3=a9?= <philmd@redhat.com>,
 qemu devel list <qemu-devel@nongnu.org>
References: <20190918171141.15957-1-lersek@redhat.com>
 <2d02cb02-27ce-081b-c9ec-4c4430503749@redhat.com>
From: Laszlo Ersek <lersek@redhat.com>
Message-ID: <6a5b3a61-0d52-6866-9fb9-4d71e5f01483@redhat.com>
Date: Thu, 19 Sep 2019 21:08:06 +0200
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101
 Thunderbird/52.9.1
MIME-Version: 1.0
In-Reply-To: <2d02cb02-27ce-081b-c9ec-4c4430503749@redhat.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.13
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.63]); Thu, 19 Sep 2019 19:08:13 +0000 (UTC)
Content-Transfer-Encoding: quoted-printable
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
X-Received-From: 209.132.183.28
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: John Snow <jsnow@redhat.com>, Eduardo Habkost <ehabkost@redhat.com>,
 Cleber Rosa <crosa@redhat.com>
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>

On 09/19/19 18:39, Philippe Mathieu-Daud=C3=A9 wrote:
> On 9/18/19 7:11 PM, Laszlo Ersek wrote:
>> It turns out that forcing python2 for running the edk2 "build" utility=
 is
>> neither necessary nor sufficient.
>>
>> Forcing python2 is not sufficient for two reasons:
>>
>> - QEMU is moving away from python2, with python2 nearing EOL,
>>
>> - according to my most recent testing, the lacking dependency informat=
ion
>>   in the makefiles that are generated by edk2's "build" utility can ca=
use
>>   parallel build failures even when "build" is executed by python2.
>>
>> And forcing python2 is not necessary because we can still return to th=
e
>> original idea of filtering out jobserver-related options from MAKEFLAG=
S.
>> So do that.
>=20
> FYI I tried uninstalling python2 on Fedora 29,
>=20
> $ make -C roms efi -j8
> make: Entering directory '/home/phil/source/qemu/roms'
> make -C edk2/BaseTools \
>         EXTRA_OPTFLAGS=3D'' \
>         EXTRA_LDFLAGS=3D''
> make[1]: Entering directory '/home/phil/source/qemu/roms/edk2/BaseTools=
'
> [...]
> make -C Tests
> make[2]: Entering directory
> '/home/phil/source/qemu/roms/edk2/BaseTools/Tests'
> /bin/sh: python: command not found
> make[2]: *** [GNUmakefile:11: test] Error 127
>=20
> 'python' seems to be provided by python-unversioned-command which is
> wired to Python2:
>=20
> $ dnf info python-unversioned-command
> Last metadata expiration check: 0:03:08 ago on Thu 19 Sep 2019 04:21:21
> PM UTC.
> Available Packages
> Name         : python-unversioned-command
> Version      : 2.7.16
> Release      : 2.fc29
> Arch         : noarch
> Size         : 13 k
> Source       : python2-2.7.16-2.fc29.src.rpm
> Repo         : updates
> Summary      : The "python" command that runs Python 2
> URL          : https://www.python.org/
> License      : Python
> Description  : This package contains /usr/bin/python - the "python"
> command that runs Python 2.
>=20
> I had to manually run update-alternatives to continue:
>=20
> $ sudo update-alternatives --install /usr/bin/python python
> /usr/bin/python3 69
>=20
> Not sure this is the expected behavior, it is confusing.
>=20

The python detection is not fool-proof in edk2. A description is given at=
:

https://github.com/tianocore/tianocore.github.io/wiki/BaseTools-Support-P=
ython2-Python3

To summarize that, it works like this, on Linux:

- if you set PYTHON_COMMAND, then the binary pointed to by
PYTHON_COMMAND will be used. The edk2 build infrastructure will
determine whether the pointed-to binary is python 2 or python 3, and
branch to the corresponding implementation of the build tools.

- Otherwise, *minor* version auto-detection is attempted. With
PYTHON3_ENABLE unset, or set to "TRUE", this minor version autodetection
will aim at minor versions of python3.

- Otherwise (=3D PYTHON3_ENABLE set to a string different from "TRUE"),
the minor version auto-detection will focus on python2.

With this patch applied, the middle case is active. Apparently it fails,
because the edk2 build tools developers could not foresee the situations
that you've exposed the auto-detection to, on Ubuntu and Fedora. Back
when I tested the python3 enablement in edk2, I checked the patches in
the following environments:

- on RHEL-7 with the system python 2,
- on RHEL-7 with python3.4 from EPEL-7,
- on RHEL-8 with python3.6,
- on RHEL-8 with platform-python.

Everything worked fine for me. I have no clue what's going on in Ubuntu
and in Fedora.

Can we require all build host installations -- where we expect to run
"make efi" -- to provide a Python 3 binary on $PATH that is plainly
called "python3"?

Then I think this patch should work. (If necessary, I could set
"PYTHON_COMMAND=3Dpython3", too.)

Thanks!
Laszlo

