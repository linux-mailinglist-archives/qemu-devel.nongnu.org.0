Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id C2060623FCA
	for <lists+qemu-devel@lfdr.de>; Thu, 10 Nov 2022 11:30:12 +0100 (CET)
Received: from localhost ([::1] helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces@nongnu.org>)
	id 1ot4nk-0000wi-Un; Thu, 10 Nov 2022 05:28:52 -0500
Received: from eggs.gnu.org ([2001:470:142:3::10])
 by lists.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <maz@kernel.org>) id 1ot4ni-0000wT-Ov
 for qemu-devel@nongnu.org; Thu, 10 Nov 2022 05:28:50 -0500
Received: from dfw.source.kernel.org ([2604:1380:4641:c500::1])
 by eggs.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <maz@kernel.org>) id 1ot4ng-00064s-TB
 for qemu-devel@nongnu.org; Thu, 10 Nov 2022 05:28:50 -0500
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
 (No client certificate requested)
 by dfw.source.kernel.org (Postfix) with ESMTPS id B952F6106F;
 Thu, 10 Nov 2022 10:28:45 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 2698BC433C1;
 Thu, 10 Nov 2022 10:28:45 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
 s=k20201202; t=1668076125;
 bh=xXzZzs5/fLCfogb13unEvFd90Zp8K6Hd5OUAlRpv9fM=;
 h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
 b=Pjk7wWdQedbJEOMbhGjbTOxS6rpJFsew3Q8W/0QQgV0USCNbRLtt1QwSP2Hh//abw
 ps6pfE4HuGSbOBI0rGl1l1w1CsJ9ysdXLcw3T0mybccPyn21r/OTp7uXd1HE8jImHl
 BGaxxrrzZZaXytbZz2VQ12ENuMLgZnTNz+UxfkgzRU7zXam5B0nVMcCdB2UfRczQrb
 WAVA+yU1rPpo+Wi7HUlkX3lxrM2j2j7BuZ3AECkn3LcfaGVEy7xKHhQki9s1JpACaM
 QkaS1AjHvlf5BmR6wOuxOfJVszD09uIDQbEV57hEWR+8vreHyqsbrpXslH/ehZodQj
 VWSLyPNoVHqrA==
Received: from sofa.misterjones.org ([185.219.108.64]
 helo=goblin-girl.misterjones.org)
 by disco-boy.misterjones.org with esmtpsa (TLS1.3) tls
 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (Exim 4.95)
 (envelope-from <maz@kernel.org>) id 1ot4na-0057df-Qg;
 Thu, 10 Nov 2022 10:28:43 +0000
Date: Thu, 10 Nov 2022 10:28:42 +0000
Message-ID: <86r0ybp0h1.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: "chenxiang (M)" <chenxiang66@hisilicon.com>
Cc: <alex.williamson@redhat.com>, <kvm@vger.kernel.org>,
 <qemu-devel@nongnu.org>, <linuxarm@huawei.com>
Subject: Re: [PATCH] KVM: Add system call KVM_VERIFY_MSI to verify MSI vector
In-Reply-To: <a55310da-2ed3-f837-71c2-d09764f83538@hisilicon.com>
References: <1667894937-175291-1-git-send-email-chenxiang66@hisilicon.com>
 <86wn85pq8f.wl-maz@kernel.org>
 <a55310da-2ed3-f837-71c2-d09764f83538@hisilicon.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: chenxiang66@hisilicon.com, alex.williamson@redhat.com,
 kvm@vger.kernel.org, qemu-devel@nongnu.org, linuxarm@huawei.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org);
 SAEximRunCond expanded to false
Received-SPF: pass client-ip=2604:1380:4641:c500::1;
 envelope-from=maz@kernel.org; helo=dfw.source.kernel.org
X-Spam_score_int: -70
X-Spam_score: -7.1
X-Spam_bar: -------
X-Spam_report: (-7.1 / 5.0 requ) BAYES_00=-1.9, DKIMWL_WL_HIGH=-0.001,
 DKIM_SIGNED=0.1, DKIM_VALID=-0.1, DKIM_VALID_AU=-0.1, DKIM_VALID_EF=-0.1,
 RCVD_IN_DNSWL_HI=-5, SPF_HELO_NONE=0.001,
 SPF_PASS=-0.001 autolearn=ham autolearn_force=no
X-Spam_action: no action
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org

On Wed, 09 Nov 2022 06:21:18 +0000,
"chenxiang (M)" <chenxiang66@hisilicon.com> wrote:
>=20
> Hi Marc,
>=20
>=20
> =E5=9C=A8 2022/11/8 20:47, Marc Zyngier =E5=86=99=E9=81=93:
> > On Tue, 08 Nov 2022 08:08:57 +0000,
> > chenxiang <chenxiang66@hisilicon.com> wrote:
> >> From: Xiang Chen <chenxiang66@hisilicon.com>
> >>=20
> >> Currently the numbers of MSI vectors come from register PCI_MSI_FLAGS
> >> which should be power-of-2, but in some scenaries it is not the same as
> >> the number that driver requires in guest, for example, a PCI driver wa=
nts
> >> to allocate 6 MSI vecotrs in guest, but as the limitation, it will all=
ocate
> >> 8 MSI vectors. So it requires 8 MSI vectors in qemu while the driver in
> >> guest only wants to allocate 6 MSI vectors.
> >>=20
> >> When GICv4.1 is enabled, we can see some exception print as following =
for
> >> above scenaro:
> >> vfio-pci 0000:3a:00.1: irq bypass producer (token 000000008f08224d) re=
gistration fails:66311
> >>=20
> >> In order to verify whether a MSI vector is valid, add KVM_VERIFY_MSI t=
o do
> >> that. If there is a mapping, return 0, otherwise return negative value.
> >>=20
> >> This is the kernel part of adding system call KVM_VERIFY_MSI.
> > Exposing something that is an internal implementation detail to
> > userspace feels like the absolute wrong way to solve this issue.
> >=20
> > Can you please characterise the issue you're having? Is it that vfio
> > tries to enable an interrupt for which there is no virtual ITS
> > mapping? Shouldn't we instead try and manage this in the kernel?
>=20
> Before i reported the issue to community, you gave a suggestion about
> the issue, but not sure whether i misundertood your meaning.
> You can refer to the link for more details about the issue.
> https://lkml.kernel.org/lkml/87cze9lcut.wl-maz@kernel.org/T/

Right. It would have been helpful to mention this earlier. Anyway, I
would really like this to be done without involving userspace at all.

But first, can you please confirm that the VM works as expected
despite the message? If that's the case, we only need to handle the
case where this is a multi-MSI setup, and I think this can be done in
VFIO, without involving userspace.

Thanks,

	M.

--=20
Without deviation from the norm, progress is not possible.

