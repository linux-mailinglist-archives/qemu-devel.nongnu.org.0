Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id 00DBD168DB6
	for <lists+qemu-devel@lfdr.de>; Sat, 22 Feb 2020 09:52:45 +0100 (CET)
Received: from localhost ([::1]:40280 helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>)
	id 1j5QWh-0006Ys-Ni
	for lists+qemu-devel@lfdr.de; Sat, 22 Feb 2020 03:52:44 -0500
Received: from eggs.gnu.org ([2001:470:142:3::10]:38090)
 by lists.gnu.org with esmtp (Exim 4.90_1)
 (envelope-from <stefanha@redhat.com>) id 1j5QVF-0004m6-Fi
 for qemu-devel@nongnu.org; Sat, 22 Feb 2020 03:51:15 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
 (envelope-from <stefanha@redhat.com>) id 1j5QVD-0007wh-IO
 for qemu-devel@nongnu.org; Sat, 22 Feb 2020 03:51:13 -0500
Received: from us-smtp-delivery-1.mimecast.com ([207.211.31.120]:51469
 helo=us-smtp-1.mimecast.com)
 by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
 (Exim 4.71) (envelope-from <stefanha@redhat.com>) id 1j5QVD-0007wZ-DD
 for qemu-devel@nongnu.org; Sat, 22 Feb 2020 03:51:11 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
 s=mimecast20190719; t=1582361471;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=MBUfYujE9Kbkyo1GiojdarL4Oy1k6hvTlcWXDO6ts6E=;
 b=R6tYjxsXDI4U/gBlqTbTQuR8yQxzBVK6HHxAgrPb9j/tSaLfbUCYpV6dpoRoml/Nu/S01A
 Nc3Bc7vYCoJhsLJmShic6FZ6pYBLNDUPDw6qc+4bYdOBkhPkANwW+AA16ZErZ1wo/vLn33
 8DbyDYV5q1Ogkey6lwlhPMP+7GpRdA4=
Received: from mimecast-mx01.redhat.com (mimecast-mx01.redhat.com
 [209.132.183.4]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-403-Uz47TgrNN2SNnpWIYejXPw-1; Sat, 22 Feb 2020 03:51:06 -0500
X-MC-Unique: Uz47TgrNN2SNnpWIYejXPw-1
Received: from smtp.corp.redhat.com (int-mx08.intmail.prod.int.phx2.redhat.com
 [10.5.11.23])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mimecast-mx01.redhat.com (Postfix) with ESMTPS id 9F470107ACC5;
 Sat, 22 Feb 2020 08:51:04 +0000 (UTC)
Received: from localhost (ovpn-116-74.ams2.redhat.com [10.36.116.74])
 by smtp.corp.redhat.com (Postfix) with ESMTP id C0CAF2709B;
 Sat, 22 Feb 2020 08:51:03 +0000 (UTC)
From: Stefan Hajnoczi <stefanha@redhat.com>
To: qemu-devel@nongnu.org
Subject: [PULL 04/31] util/async: make bh_aio_poll() O(1)
Date: Sat, 22 Feb 2020 08:50:03 +0000
Message-Id: <20200222085030.1760640-5-stefanha@redhat.com>
In-Reply-To: <20200222085030.1760640-1-stefanha@redhat.com>
References: <20200222085030.1760640-1-stefanha@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.23
X-Mimecast-Spam-Score: 0
X-Mimecast-Originator: redhat.com
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: base64
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
 [fuzzy]
X-Received-From: 207.211.31.120
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Kevin Wolf <kwolf@redhat.com>, Peter Maydell <peter.maydell@linaro.org>,
 Thomas Huth <thuth@redhat.com>, Eduardo Habkost <ehabkost@redhat.com>,
 qemu-block@nongnu.org, "Michael S. Tsirkin" <mst@redhat.com>,
 Laurent Vivier <lvivier@redhat.com>, Max Reitz <mreitz@redhat.com>,
 Alexander Bulekov <alxndr@bu.edu>, Bandan Das <bsd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>,
 =?UTF-8?q?Marc-Andr=C3=A9=20Lureau?= <marcandre.lureau@redhat.com>,
 Paolo Bonzini <pbonzini@redhat.com>, Fam Zheng <fam@euphon.net>,
 Richard Henderson <rth@twiddle.net>
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>

VGhlIGN0eC0+Zmlyc3RfYmggbGlzdCBjb250YWlucyBhbGwgY3JlYXRlZCBCSHMsIGluY2x1ZGlu
ZyB0aG9zZSB0aGF0CmFyZSBub3Qgc2NoZWR1bGVkLiAgVGhlIGxpc3QgaXMgaXRlcmF0ZWQgYnkg
dGhlIGV2ZW50IGxvb3AgYW5kIHRoZXJlZm9yZQpoYXMgTyhuKSB0aW1lIGNvbXBsZXhpdHkgd2l0
aCByZXNwZWN0ZWQgdG8gdGhlIG51bWJlciBvZiBjcmVhdGVkIEJIcy4KClJld3JpdGUgQkhzIHNv
IHRoYXQgb25seSBzY2hlZHVsZWQgb3IgZGVsZXRlZCBCSHMgYXJlIGVucXVldWVkLgpPbmx5IEJI
cyB0aGF0IGFjdHVhbGx5IHJlcXVpcmUgYWN0aW9uIHdpbGwgYmUgaXRlcmF0ZWQuCgpPbmUgc2Vt
YW50aWMgY2hhbmdlIGlzIHJlcXVpcmVkOiBxZW11X2JoX2RlbGV0ZSgpIGVucXVldWVzIHRoZSBC
SCBhbmQKdGhlcmVmb3JlIGludm9rZXMgYWlvX25vdGlmeSgpLiAgVGhlCnRlc3RzL3Rlc3QtYWlv
LmM6dGVzdF9zb3VyY2VfYmhfZGVsZXRlX2Zyb21fY2IoKSB0ZXN0IGNhc2UgYXNzdW1lZCB0aGF0
CmdfbWFpbl9jb250ZXh0X2l0ZXJhdGlvbihOVUxMLCBmYWxzZSkgcmV0dXJucyBmYWxzZSBhZnRl
cgpxZW11X2JoX2RlbGV0ZSgpIGJ1dCBpdCBub3cgcmV0dXJucyB0cnVlIGZvciBvbmUgaXRlcmF0
aW9uLiAgRml4IHVwIHRoZQp0ZXN0IGNhc2UuCgpUaGlzIHBhdGNoIG1ha2VzIGFpb19jb21wdXRl
X3RpbWVvdXQoKSBhbmQgYWlvX2JoX3BvbGwoKSBkcm9wIGZyb20gYSBDUFUKcHJvZmlsZSByZXBv
cnRlZCBieSBwZXJmLXRvcCgxKS4gIFByZXZpb3VzbHkgdGhleSBjb21iaW5lZCB0byA5JSBDUFUK
dXRpbGl6YXRpb24gd2hlbiBBaW9Db250ZXh0IHBvbGxpbmcgaXMgY29tbWVudGVkIG91dCBhbmQg
dGhlIGd1ZXN0IGhhcyAyCnZpcnRpby1ibGssbnVtLXF1ZXVlcz0xIGFuZCA5OSB2aXJ0aW8tYmxr
LG51bS1xdWV1ZXM9MzIgZGV2aWNlcy4KClNpZ25lZC1vZmYtYnk6IFN0ZWZhbiBIYWpub2N6aSA8
c3RlZmFuaGFAcmVkaGF0LmNvbT4KUmV2aWV3ZWQtYnk6IFBhb2xvIEJvbnppbmkgPHBib256aW5p
QHJlZGhhdC5jb20+Ck1lc3NhZ2UtaWQ6IDIwMjAwMjIxMDkzOTUxLjE0MTQ2OTMtMS1zdGVmYW5o
YUByZWRoYXQuY29tClNpZ25lZC1vZmYtYnk6IFN0ZWZhbiBIYWpub2N6aSA8c3RlZmFuaGFAcmVk
aGF0LmNvbT4KLS0tCiBpbmNsdWRlL2Jsb2NrL2Fpby5oIHwgIDIwICsrKy0KIHRlc3RzL3Rlc3Qt
YWlvLmMgICAgfCAgIDMgKy0KIHV0aWwvYXN5bmMuYyAgICAgICAgfCAyMzcgKysrKysrKysrKysr
KysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0KIDMgZmlsZXMgY2hhbmdlZCwgMTU4IGlu
c2VydGlvbnMoKyksIDEwMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9pbmNsdWRlL2Jsb2Nr
L2Fpby5oIGIvaW5jbHVkZS9ibG9jay9haW8uaAppbmRleCA3YmE5YmQ3ODc0Li4xYTJjZTljYTI2
IDEwMDY0NAotLS0gYS9pbmNsdWRlL2Jsb2NrL2Fpby5oCisrKyBiL2luY2x1ZGUvYmxvY2svYWlv
LmgKQEAgLTUxLDYgKzUxLDE5IEBAIHN0cnVjdCBUaHJlYWRQb29sOwogc3RydWN0IExpbnV4QWlv
U3RhdGU7CiBzdHJ1Y3QgTHVyaW5nU3RhdGU7CiAKKy8qCisgKiBFYWNoIGFpb19iaF9wb2xsKCkg
Y2FsbCBjYXJ2ZXMgb2ZmIGEgc2xpY2Ugb2YgdGhlIEJIIGxpc3QsIHNvIHRoYXQgbmV3bHkKKyAq
IHNjaGVkdWxlZCBCSHMgYXJlIG5vdCBwcm9jZXNzZWQgdW50aWwgdGhlIG5leHQgYWlvX2JoX3Bv
bGwoKSBjYWxsLiAgQWxsCisgKiBhY3RpdmUgYWlvX2JoX3BvbGwoKSBjYWxscyBjaGFpbiB0aGVp
ciBzbGljZXMgdG9nZXRoZXIgaW4gYSBsaXN0LCBzbyB0aGF0CisgKiBuZXN0ZWQgYWlvX2JoX3Bv
bGwoKSBjYWxscyBwcm9jZXNzIGFsbCBzY2hlZHVsZWQgYm90dG9tIGhhbHZlcy4KKyAqLwordHlw
ZWRlZiBRU0xJU1RfSEVBRCgsIFFFTVVCSCkgQkhMaXN0OwordHlwZWRlZiBzdHJ1Y3QgQkhMaXN0
U2xpY2UgQkhMaXN0U2xpY2U7CitzdHJ1Y3QgQkhMaXN0U2xpY2UgeworICAgIEJITGlzdCBiaF9s
aXN0OworICAgIFFTSU1QTEVRX0VOVFJZKEJITGlzdFNsaWNlKSBuZXh0OworfTsKKwogc3RydWN0
IEFpb0NvbnRleHQgewogICAgIEdTb3VyY2Ugc291cmNlOwogCkBAIC05MSw4ICsxMDQsMTEgQEAg
c3RydWN0IEFpb0NvbnRleHQgewogICAgICAqLwogICAgIFFlbXVMb2NrQ250IGxpc3RfbG9jazsK
IAotICAgIC8qIEFuY2hvciBvZiB0aGUgbGlzdCBvZiBCb3R0b20gSGFsdmVzIGJlbG9uZ2luZyB0
byB0aGUgY29udGV4dCAqLwotICAgIHN0cnVjdCBRRU1VQkggKmZpcnN0X2JoOworICAgIC8qIEJv
dHRvbSBIYWx2ZXMgcGVuZGluZyBhaW9fYmhfcG9sbCgpIHByb2Nlc3NpbmcgKi8KKyAgICBCSExp
c3QgYmhfbGlzdDsKKworICAgIC8qIENoYWluZWQgQkggbGlzdCBzbGljZXMgZm9yIGVhY2ggbmVz
dGVkIGFpb19iaF9wb2xsKCkgY2FsbCAqLworICAgIFFTSU1QTEVRX0hFQUQoLCBCSExpc3RTbGlj
ZSkgYmhfc2xpY2VfbGlzdDsKIAogICAgIC8qIFVzZWQgYnkgYWlvX25vdGlmeS4KICAgICAgKgpk
aWZmIC0tZ2l0IGEvdGVzdHMvdGVzdC1haW8uYyBiL3Rlc3RzL3Rlc3QtYWlvLmMKaW5kZXggODZm
YjczYjNkNS4uOGE0NjA3ODQ2MyAxMDA2NDQKLS0tIGEvdGVzdHMvdGVzdC1haW8uYworKysgYi90
ZXN0cy90ZXN0LWFpby5jCkBAIC02MTUsNyArNjE1LDggQEAgc3RhdGljIHZvaWQgdGVzdF9zb3Vy
Y2VfYmhfZGVsZXRlX2Zyb21fY2Iodm9pZCkKICAgICBnX2Fzc2VydF9jbXBpbnQoZGF0YTEubiwg
PT0sIGRhdGExLm1heCk7CiAgICAgZ19hc3NlcnQoZGF0YTEuYmggPT0gTlVMTCk7CiAKLSAgICBn
X2Fzc2VydCghZ19tYWluX2NvbnRleHRfaXRlcmF0aW9uKE5VTEwsIGZhbHNlKSk7CisgICAgYXNz
ZXJ0KGdfbWFpbl9jb250ZXh0X2l0ZXJhdGlvbihOVUxMLCBmYWxzZSkpOworICAgIGFzc2VydCgh
Z19tYWluX2NvbnRleHRfaXRlcmF0aW9uKE5VTEwsIGZhbHNlKSk7CiB9CiAKIHN0YXRpYyB2b2lk
IHRlc3Rfc291cmNlX2JoX2RlbGV0ZV9mcm9tX2NiX21hbnkodm9pZCkKZGlmZiAtLWdpdCBhL3V0
aWwvYXN5bmMuYyBiL3V0aWwvYXN5bmMuYwppbmRleCBjMTkyYTI0YTYxLi5iOTQ1MThiOTQ4IDEw
MDY0NAotLS0gYS91dGlsL2FzeW5jLmMKKysrIGIvdXRpbC9hc3luYy5jCkBAIC0yOSw2ICsyOSw3
IEBACiAjaW5jbHVkZSAiYmxvY2svdGhyZWFkLXBvb2wuaCIKICNpbmNsdWRlICJxZW11L21haW4t
bG9vcC5oIgogI2luY2x1ZGUgInFlbXUvYXRvbWljLmgiCisjaW5jbHVkZSAicWVtdS9yY3VfcXVl
dWUuaCIKICNpbmNsdWRlICJibG9jay9yYXctYWlvLmgiCiAjaW5jbHVkZSAicWVtdS9jb3JvdXRp
bmVfaW50LmgiCiAjaW5jbHVkZSAidHJhY2UuaCIKQEAgLTM2LDE2ICszNyw3NiBAQAogLyoqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwog
LyogYm90dG9tIGhhbHZlcyAoY2FuIGJlIHNlZW4gYXMgdGltZXJzIHdoaWNoIGV4cGlyZSBBU0FQ
KSAqLwogCisvKiBRRU1VQkg6OmZsYWdzIHZhbHVlcyAqLworZW51bSB7CisgICAgLyogQWxyZWFk
eSBlbnF1ZXVlZCBhbmQgd2FpdGluZyBmb3IgYWlvX2JoX3BvbGwoKSAqLworICAgIEJIX1BFTkRJ
TkcgICA9ICgxIDw8IDApLAorCisgICAgLyogSW52b2tlIHRoZSBjYWxsYmFjayAqLworICAgIEJI
X1NDSEVEVUxFRCA9ICgxIDw8IDEpLAorCisgICAgLyogRGVsZXRlIHdpdGhvdXQgaW52b2tpbmcg
Y2FsbGJhY2sgKi8KKyAgICBCSF9ERUxFVEVEICAgPSAoMSA8PCAyKSwKKworICAgIC8qIERlbGV0
ZSBhZnRlciBpbnZva2luZyBjYWxsYmFjayAqLworICAgIEJIX09ORVNIT1QgICA9ICgxIDw8IDMp
LAorCisgICAgLyogU2NoZWR1bGUgcGVyaW9kaWNhbGx5IHdoZW4gdGhlIGV2ZW50IGxvb3AgaXMg
aWRsZSAqLworICAgIEJIX0lETEUgICAgICA9ICgxIDw8IDQpLAorfTsKKwogc3RydWN0IFFFTVVC
SCB7CiAgICAgQWlvQ29udGV4dCAqY3R4OwogICAgIFFFTVVCSEZ1bmMgKmNiOwogICAgIHZvaWQg
Km9wYXF1ZTsKLSAgICBRRU1VQkggKm5leHQ7Ci0gICAgYm9vbCBzY2hlZHVsZWQ7Ci0gICAgYm9v
bCBpZGxlOwotICAgIGJvb2wgZGVsZXRlZDsKKyAgICBRU0xJU1RfRU5UUlkoUUVNVUJIKSBuZXh0
OworICAgIHVuc2lnbmVkIGZsYWdzOwogfTsKIAorLyogQ2FsbGVkIGNvbmN1cnJlbnRseSBmcm9t
IGFueSB0aHJlYWQgKi8KK3N0YXRpYyB2b2lkIGFpb19iaF9lbnF1ZXVlKFFFTVVCSCAqYmgsIHVu
c2lnbmVkIG5ld19mbGFncykKK3sKKyAgICBBaW9Db250ZXh0ICpjdHggPSBiaC0+Y3R4OworICAg
IHVuc2lnbmVkIG9sZF9mbGFnczsKKworICAgIC8qCisgICAgICogVGhlIG1lbW9yeSBiYXJyaWVy
IGltcGxpY2l0IGluIGF0b21pY19mZXRjaF9vciBtYWtlcyBzdXJlIHRoYXQ6CisgICAgICogMS4g
aWRsZSAmIGFueSB3cml0ZXMgbmVlZGVkIGJ5IHRoZSBjYWxsYmFjayBhcmUgZG9uZSBiZWZvcmUg
dGhlCisgICAgICogICAgbG9jYXRpb25zIGFyZSByZWFkIGluIHRoZSBhaW9fYmhfcG9sbC4KKyAg
ICAgKiAyLiBjdHggaXMgbG9hZGVkIGJlZm9yZSB0aGUgY2FsbGJhY2sgaGFzIGEgY2hhbmNlIHRv
IGV4ZWN1dGUgYW5kIGJoCisgICAgICogICAgY291bGQgYmUgZnJlZWQuCisgICAgICovCisgICAg
b2xkX2ZsYWdzID0gYXRvbWljX2ZldGNoX29yKCZiaC0+ZmxhZ3MsIEJIX1BFTkRJTkcgfCBuZXdf
ZmxhZ3MpOworICAgIGlmICghKG9sZF9mbGFncyAmIEJIX1BFTkRJTkcpKSB7CisgICAgICAgIFFT
TElTVF9JTlNFUlRfSEVBRF9BVE9NSUMoJmN0eC0+YmhfbGlzdCwgYmgsIG5leHQpOworICAgIH0K
KworICAgIGFpb19ub3RpZnkoY3R4KTsKK30KKworLyogT25seSBjYWxsZWQgZnJvbSBhaW9fYmhf
cG9sbCgpIGFuZCBhaW9fY3R4X2ZpbmFsaXplKCkgKi8KK3N0YXRpYyBRRU1VQkggKmFpb19iaF9k
ZXF1ZXVlKEJITGlzdCAqaGVhZCwgdW5zaWduZWQgKmZsYWdzKQoreworICAgIFFFTVVCSCAqYmgg
PSBRU0xJU1RfRklSU1RfUkNVKGhlYWQpOworCisgICAgaWYgKCFiaCkgeworICAgICAgICByZXR1
cm4gTlVMTDsKKyAgICB9CisKKyAgICBRU0xJU1RfUkVNT1ZFX0hFQUQoaGVhZCwgbmV4dCk7CisK
KyAgICAvKgorICAgICAqIFRoZSBhdG9taWNfYW5kIGlzIHBhaXJlZCB3aXRoIGFpb19iaF9lbnF1
ZXVlKCkuICBUaGUgaW1wbGljaXQgbWVtb3J5CisgICAgICogYmFycmllciBlbnN1cmVzIHRoYXQg
dGhlIGNhbGxiYWNrIHNlZXMgYWxsIHdyaXRlcyBkb25lIGJ5IHRoZSBzY2hlZHVsaW5nCisgICAg
ICogdGhyZWFkLiAgSXQgYWxzbyBlbnN1cmVzIHRoYXQgdGhlIHNjaGVkdWxpbmcgdGhyZWFkIHNl
ZXMgdGhlIGNsZWFyZWQKKyAgICAgKiBmbGFnIGJlZm9yZSBiaC0+Y2IgaGFzIHJ1biwgYW5kIHRo
dXMgd2lsbCBjYWxsIGFpb19ub3RpZnkgYWdhaW4gaWYKKyAgICAgKiBuZWNlc3NhcnkuCisgICAg
ICovCisgICAgKmZsYWdzID0gYXRvbWljX2ZldGNoX2FuZCgmYmgtPmZsYWdzLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgfihCSF9QRU5ESU5HIHwgQkhfU0NIRURVTEVEIHwgQkhfSURM
RSkpOworICAgIHJldHVybiBiaDsKK30KKwogdm9pZCBhaW9fYmhfc2NoZWR1bGVfb25lc2hvdChB
aW9Db250ZXh0ICpjdHgsIFFFTVVCSEZ1bmMgKmNiLCB2b2lkICpvcGFxdWUpCiB7CiAgICAgUUVN
VUJIICpiaDsKQEAgLTU1LDE1ICsxMTYsNyBAQCB2b2lkIGFpb19iaF9zY2hlZHVsZV9vbmVzaG90
KEFpb0NvbnRleHQgKmN0eCwgUUVNVUJIRnVuYyAqY2IsIHZvaWQgKm9wYXF1ZSkKICAgICAgICAg
LmNiID0gY2IsCiAgICAgICAgIC5vcGFxdWUgPSBvcGFxdWUsCiAgICAgfTsKLSAgICBxZW11X2xv
Y2tjbnRfbG9jaygmY3R4LT5saXN0X2xvY2spOwotICAgIGJoLT5uZXh0ID0gY3R4LT5maXJzdF9i
aDsKLSAgICBiaC0+c2NoZWR1bGVkID0gMTsKLSAgICBiaC0+ZGVsZXRlZCA9IDE7Ci0gICAgLyog
TWFrZSBzdXJlIHRoYXQgdGhlIG1lbWJlcnMgYXJlIHJlYWR5IGJlZm9yZSBwdXR0aW5nIGJoIGlu
dG8gbGlzdCAqLwotICAgIHNtcF93bWIoKTsKLSAgICBjdHgtPmZpcnN0X2JoID0gYmg7Ci0gICAg
cWVtdV9sb2NrY250X3VubG9jaygmY3R4LT5saXN0X2xvY2spOwotICAgIGFpb19ub3RpZnkoY3R4
KTsKKyAgICBhaW9fYmhfZW5xdWV1ZShiaCwgQkhfU0NIRURVTEVEIHwgQkhfT05FU0hPVCk7CiB9
CiAKIFFFTVVCSCAqYWlvX2JoX25ldyhBaW9Db250ZXh0ICpjdHgsIFFFTVVCSEZ1bmMgKmNiLCB2
b2lkICpvcGFxdWUpCkBAIC03NSwxMiArMTI4LDYgQEAgUUVNVUJIICphaW9fYmhfbmV3KEFpb0Nv
bnRleHQgKmN0eCwgUUVNVUJIRnVuYyAqY2IsIHZvaWQgKm9wYXF1ZSkKICAgICAgICAgLmNiID0g
Y2IsCiAgICAgICAgIC5vcGFxdWUgPSBvcGFxdWUsCiAgICAgfTsKLSAgICBxZW11X2xvY2tjbnRf
bG9jaygmY3R4LT5saXN0X2xvY2spOwotICAgIGJoLT5uZXh0ID0gY3R4LT5maXJzdF9iaDsKLSAg
ICAvKiBNYWtlIHN1cmUgdGhhdCB0aGUgbWVtYmVycyBhcmUgcmVhZHkgYmVmb3JlIHB1dHRpbmcg
YmggaW50byBsaXN0ICovCi0gICAgc21wX3dtYigpOwotICAgIGN0eC0+Zmlyc3RfYmggPSBiaDsK
LSAgICBxZW11X2xvY2tjbnRfdW5sb2NrKCZjdHgtPmxpc3RfbG9jayk7CiAgICAgcmV0dXJuIGJo
OwogfQogCkBAIC04OSw5MSArMTM2LDU2IEBAIHZvaWQgYWlvX2JoX2NhbGwoUUVNVUJIICpiaCkK
ICAgICBiaC0+Y2IoYmgtPm9wYXF1ZSk7CiB9CiAKLS8qIE11bHRpcGxlIG9jY3VycmVuY2VzIG9m
IGFpb19iaF9wb2xsIGNhbm5vdCBiZSBjYWxsZWQgY29uY3VycmVudGx5LgotICogVGhlIGNvdW50
IGluIGN0eC0+bGlzdF9sb2NrIGlzIGluY3JlbWVudGVkIGJlZm9yZSB0aGUgY2FsbCwgYW5kIGlz
Ci0gKiBub3QgYWZmZWN0ZWQgYnkgdGhlIGNhbGwuCi0gKi8KKy8qIE11bHRpcGxlIG9jY3VycmVu
Y2VzIG9mIGFpb19iaF9wb2xsIGNhbm5vdCBiZSBjYWxsZWQgY29uY3VycmVudGx5LiAqLwogaW50
IGFpb19iaF9wb2xsKEFpb0NvbnRleHQgKmN0eCkKIHsKLSAgICBRRU1VQkggKmJoLCAqKmJocCwg
Km5leHQ7Ci0gICAgaW50IHJldDsKLSAgICBib29sIGRlbGV0ZWQgPSBmYWxzZTsKLQotICAgIHJl
dCA9IDA7Ci0gICAgZm9yIChiaCA9IGF0b21pY19yY3VfcmVhZCgmY3R4LT5maXJzdF9iaCk7IGJo
OyBiaCA9IG5leHQpIHsKLSAgICAgICAgbmV4dCA9IGF0b21pY19yY3VfcmVhZCgmYmgtPm5leHQp
OwotICAgICAgICAvKiBUaGUgYXRvbWljX3hjaGcgaXMgcGFpcmVkIHdpdGggdGhlIG9uZSBpbiBx
ZW11X2JoX3NjaGVkdWxlLiAgVGhlCi0gICAgICAgICAqIGltcGxpY2l0IG1lbW9yeSBiYXJyaWVy
IGVuc3VyZXMgdGhhdCB0aGUgY2FsbGJhY2sgc2VlcyBhbGwgd3JpdGVzCi0gICAgICAgICAqIGRv
bmUgYnkgdGhlIHNjaGVkdWxpbmcgdGhyZWFkLiAgSXQgYWxzbyBlbnN1cmVzIHRoYXQgdGhlIHNj
aGVkdWxpbmcKLSAgICAgICAgICogdGhyZWFkIHNlZXMgdGhlIHplcm8gYmVmb3JlIGJoLT5jYiBo
YXMgcnVuLCBhbmQgdGh1cyB3aWxsIGNhbGwKLSAgICAgICAgICogYWlvX25vdGlmeSBhZ2FpbiBp
ZiBuZWNlc3NhcnkuCi0gICAgICAgICAqLwotICAgICAgICBpZiAoYXRvbWljX3hjaGcoJmJoLT5z
Y2hlZHVsZWQsIDApKSB7CisgICAgQkhMaXN0U2xpY2Ugc2xpY2U7CisgICAgQkhMaXN0U2xpY2Ug
KnM7CisgICAgaW50IHJldCA9IDA7CisKKyAgICBRU0xJU1RfTU9WRV9BVE9NSUMoJnNsaWNlLmJo
X2xpc3QsICZjdHgtPmJoX2xpc3QpOworICAgIFFTSU1QTEVRX0lOU0VSVF9UQUlMKCZjdHgtPmJo
X3NsaWNlX2xpc3QsICZzbGljZSwgbmV4dCk7CisKKyAgICB3aGlsZSAoKHMgPSBRU0lNUExFUV9G
SVJTVCgmY3R4LT5iaF9zbGljZV9saXN0KSkpIHsKKyAgICAgICAgUUVNVUJIICpiaDsKKyAgICAg
ICAgdW5zaWduZWQgZmxhZ3M7CisKKyAgICAgICAgYmggPSBhaW9fYmhfZGVxdWV1ZSgmcy0+Ymhf
bGlzdCwgJmZsYWdzKTsKKyAgICAgICAgaWYgKCFiaCkgeworICAgICAgICAgICAgUVNJTVBMRVFf
UkVNT1ZFX0hFQUQoJmN0eC0+Ymhfc2xpY2VfbGlzdCwgbmV4dCk7CisgICAgICAgICAgICBjb250
aW51ZTsKKyAgICAgICAgfQorCisgICAgICAgIGlmICgoZmxhZ3MgJiAoQkhfU0NIRURVTEVEIHwg
QkhfREVMRVRFRCkpID09IEJIX1NDSEVEVUxFRCkgewogICAgICAgICAgICAgLyogSWRsZSBCSHMg
ZG9uJ3QgY291bnQgYXMgcHJvZ3Jlc3MgKi8KLSAgICAgICAgICAgIGlmICghYmgtPmlkbGUpIHsK
KyAgICAgICAgICAgIGlmICghKGZsYWdzICYgQkhfSURMRSkpIHsKICAgICAgICAgICAgICAgICBy
ZXQgPSAxOwogICAgICAgICAgICAgfQotICAgICAgICAgICAgYmgtPmlkbGUgPSAwOwogICAgICAg
ICAgICAgYWlvX2JoX2NhbGwoYmgpOwogICAgICAgICB9Ci0gICAgICAgIGlmIChiaC0+ZGVsZXRl
ZCkgewotICAgICAgICAgICAgZGVsZXRlZCA9IHRydWU7CisgICAgICAgIGlmIChmbGFncyAmIChC
SF9ERUxFVEVEIHwgQkhfT05FU0hPVCkpIHsKKyAgICAgICAgICAgIGdfZnJlZShiaCk7CiAgICAg
ICAgIH0KICAgICB9CiAKLSAgICAvKiByZW1vdmUgZGVsZXRlZCBiaHMgKi8KLSAgICBpZiAoIWRl
bGV0ZWQpIHsKLSAgICAgICAgcmV0dXJuIHJldDsKLSAgICB9Ci0KLSAgICBpZiAocWVtdV9sb2Nr
Y250X2RlY19pZl9sb2NrKCZjdHgtPmxpc3RfbG9jaykpIHsKLSAgICAgICAgYmhwID0gJmN0eC0+
Zmlyc3RfYmg7Ci0gICAgICAgIHdoaWxlICgqYmhwKSB7Ci0gICAgICAgICAgICBiaCA9ICpiaHA7
Ci0gICAgICAgICAgICBpZiAoYmgtPmRlbGV0ZWQgJiYgIWJoLT5zY2hlZHVsZWQpIHsKLSAgICAg
ICAgICAgICAgICAqYmhwID0gYmgtPm5leHQ7Ci0gICAgICAgICAgICAgICAgZ19mcmVlKGJoKTsK
LSAgICAgICAgICAgIH0gZWxzZSB7Ci0gICAgICAgICAgICAgICAgYmhwID0gJmJoLT5uZXh0Owot
ICAgICAgICAgICAgfQotICAgICAgICB9Ci0gICAgICAgIHFlbXVfbG9ja2NudF9pbmNfYW5kX3Vu
bG9jaygmY3R4LT5saXN0X2xvY2spOwotICAgIH0KICAgICByZXR1cm4gcmV0OwogfQogCiB2b2lk
IHFlbXVfYmhfc2NoZWR1bGVfaWRsZShRRU1VQkggKmJoKQogewotICAgIGJoLT5pZGxlID0gMTsK
LSAgICAvKiBNYWtlIHN1cmUgdGhhdCBpZGxlICYgYW55IHdyaXRlcyBuZWVkZWQgYnkgdGhlIGNh
bGxiYWNrIGFyZSBkb25lCi0gICAgICogYmVmb3JlIHRoZSBsb2NhdGlvbnMgYXJlIHJlYWQgaW4g
dGhlIGFpb19iaF9wb2xsLgotICAgICAqLwotICAgIGF0b21pY19tYl9zZXQoJmJoLT5zY2hlZHVs
ZWQsIDEpOworICAgIGFpb19iaF9lbnF1ZXVlKGJoLCBCSF9TQ0hFRFVMRUQgfCBCSF9JRExFKTsK
IH0KIAogdm9pZCBxZW11X2JoX3NjaGVkdWxlKFFFTVVCSCAqYmgpCiB7Ci0gICAgQWlvQ29udGV4
dCAqY3R4OwotCi0gICAgY3R4ID0gYmgtPmN0eDsKLSAgICBiaC0+aWRsZSA9IDA7Ci0gICAgLyog
VGhlIG1lbW9yeSBiYXJyaWVyIGltcGxpY2l0IGluIGF0b21pY194Y2hnIG1ha2VzIHN1cmUgdGhh
dDoKLSAgICAgKiAxLiBpZGxlICYgYW55IHdyaXRlcyBuZWVkZWQgYnkgdGhlIGNhbGxiYWNrIGFy
ZSBkb25lIGJlZm9yZSB0aGUKLSAgICAgKiAgICBsb2NhdGlvbnMgYXJlIHJlYWQgaW4gdGhlIGFp
b19iaF9wb2xsLgotICAgICAqIDIuIGN0eCBpcyBsb2FkZWQgYmVmb3JlIHNjaGVkdWxlZCBpcyBz
ZXQgYW5kIHRoZSBjYWxsYmFjayBoYXMgYSBjaGFuY2UKLSAgICAgKiAgICB0byBleGVjdXRlLgot
ICAgICAqLwotICAgIGlmIChhdG9taWNfeGNoZygmYmgtPnNjaGVkdWxlZCwgMSkgPT0gMCkgewot
ICAgICAgICBhaW9fbm90aWZ5KGN0eCk7Ci0gICAgfQorICAgIGFpb19iaF9lbnF1ZXVlKGJoLCBC
SF9TQ0hFRFVMRUQpOwogfQogCi0KIC8qIFRoaXMgZnVuYyBpcyBhc3luYy4KICAqLwogdm9pZCBx
ZW11X2JoX2NhbmNlbChRRU1VQkggKmJoKQogewotICAgIGF0b21pY19tYl9zZXQoJmJoLT5zY2hl
ZHVsZWQsIDApOworICAgIGF0b21pY19hbmQoJmJoLT5mbGFncywgfkJIX1NDSEVEVUxFRCk7CiB9
CiAKIC8qIFRoaXMgZnVuYyBpcyBhc3luYy5UaGUgYm90dG9tIGhhbGYgd2lsbCBkbyB0aGUgZGVs
ZXRlIGFjdGlvbiBhdCB0aGUgZmluaWFsCkBAIC0xODEsMjEgKzE5MywxNiBAQCB2b2lkIHFlbXVf
YmhfY2FuY2VsKFFFTVVCSCAqYmgpCiAgKi8KIHZvaWQgcWVtdV9iaF9kZWxldGUoUUVNVUJIICpi
aCkKIHsKLSAgICBiaC0+c2NoZWR1bGVkID0gMDsKLSAgICBiaC0+ZGVsZXRlZCA9IDE7CisgICAg
YWlvX2JoX2VucXVldWUoYmgsIEJIX0RFTEVURUQpOwogfQogCi1pbnQ2NF90Ci1haW9fY29tcHV0
ZV90aW1lb3V0KEFpb0NvbnRleHQgKmN0eCkKK3N0YXRpYyBpbnQ2NF90IGFpb19jb21wdXRlX2Jo
X3RpbWVvdXQoQkhMaXN0ICpoZWFkLCBpbnQgdGltZW91dCkKIHsKLSAgICBpbnQ2NF90IGRlYWRs
aW5lOwotICAgIGludCB0aW1lb3V0ID0gLTE7CiAgICAgUUVNVUJIICpiaDsKIAotICAgIGZvciAo
YmggPSBhdG9taWNfcmN1X3JlYWQoJmN0eC0+Zmlyc3RfYmgpOyBiaDsKLSAgICAgICAgIGJoID0g
YXRvbWljX3JjdV9yZWFkKCZiaC0+bmV4dCkpIHsKLSAgICAgICAgaWYgKGJoLT5zY2hlZHVsZWQp
IHsKLSAgICAgICAgICAgIGlmIChiaC0+aWRsZSkgeworICAgIFFTTElTVF9GT1JFQUNIX1JDVShi
aCwgaGVhZCwgbmV4dCkgeworICAgICAgICBpZiAoKGJoLT5mbGFncyAmIChCSF9TQ0hFRFVMRUQg
fCBCSF9ERUxFVEVEKSkgPT0gQkhfU0NIRURVTEVEKSB7CisgICAgICAgICAgICBpZiAoYmgtPmZs
YWdzICYgQkhfSURMRSkgewogICAgICAgICAgICAgICAgIC8qIGlkbGUgYm90dG9tIGhhbHZlcyB3
aWxsIGJlIHBvbGxlZCBhdCBsZWFzdAogICAgICAgICAgICAgICAgICAqIGV2ZXJ5IDEwbXMgKi8K
ICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gMTAwMDAwMDA7CkBAIC0yMDcsNiArMjE0LDI4IEBA
IGFpb19jb21wdXRlX3RpbWVvdXQoQWlvQ29udGV4dCAqY3R4KQogICAgICAgICB9CiAgICAgfQog
CisgICAgcmV0dXJuIHRpbWVvdXQ7Cit9CisKK2ludDY0X3QKK2Fpb19jb21wdXRlX3RpbWVvdXQo
QWlvQ29udGV4dCAqY3R4KQoreworICAgIEJITGlzdFNsaWNlICpzOworICAgIGludDY0X3QgZGVh
ZGxpbmU7CisgICAgaW50IHRpbWVvdXQgPSAtMTsKKworICAgIHRpbWVvdXQgPSBhaW9fY29tcHV0
ZV9iaF90aW1lb3V0KCZjdHgtPmJoX2xpc3QsIHRpbWVvdXQpOworICAgIGlmICh0aW1lb3V0ID09
IDApIHsKKyAgICAgICAgcmV0dXJuIDA7CisgICAgfQorCisgICAgUVNJTVBMRVFfRk9SRUFDSChz
LCAmY3R4LT5iaF9zbGljZV9saXN0LCBuZXh0KSB7CisgICAgICAgIHRpbWVvdXQgPSBhaW9fY29t
cHV0ZV9iaF90aW1lb3V0KCZzLT5iaF9saXN0LCB0aW1lb3V0KTsKKyAgICAgICAgaWYgKHRpbWVv
dXQgPT0gMCkgeworICAgICAgICAgICAgcmV0dXJuIDA7CisgICAgICAgIH0KKyAgICB9CisKICAg
ICBkZWFkbGluZSA9IHRpbWVybGlzdGdyb3VwX2RlYWRsaW5lX25zKCZjdHgtPnRsZyk7CiAgICAg
aWYgKGRlYWRsaW5lID09IDApIHsKICAgICAgICAgcmV0dXJuIDA7CkBAIC0yMzcsMTUgKzI2Niwy
NCBAQCBhaW9fY3R4X2NoZWNrKEdTb3VyY2UgKnNvdXJjZSkKIHsKICAgICBBaW9Db250ZXh0ICpj
dHggPSAoQWlvQ29udGV4dCAqKSBzb3VyY2U7CiAgICAgUUVNVUJIICpiaDsKKyAgICBCSExpc3RT
bGljZSAqczsKIAogICAgIGF0b21pY19hbmQoJmN0eC0+bm90aWZ5X21lLCB+MSk7CiAgICAgYWlv
X25vdGlmeV9hY2NlcHQoY3R4KTsKIAotICAgIGZvciAoYmggPSBjdHgtPmZpcnN0X2JoOyBiaDsg
YmggPSBiaC0+bmV4dCkgewotICAgICAgICBpZiAoYmgtPnNjaGVkdWxlZCkgeworICAgIFFTTElT
VF9GT1JFQUNIX1JDVShiaCwgJmN0eC0+YmhfbGlzdCwgbmV4dCkgeworICAgICAgICBpZiAoKGJo
LT5mbGFncyAmIChCSF9TQ0hFRFVMRUQgfCBCSF9ERUxFVEVEKSkgPT0gQkhfU0NIRURVTEVEKSB7
CiAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgfQogICAgIH0KKworICAgIFFTSU1Q
TEVRX0ZPUkVBQ0gocywgJmN0eC0+Ymhfc2xpY2VfbGlzdCwgbmV4dCkgeworICAgICAgICBRU0xJ
U1RfRk9SRUFDSF9SQ1UoYmgsICZzLT5iaF9saXN0LCBuZXh0KSB7CisgICAgICAgICAgICBpZiAo
KGJoLT5mbGFncyAmIChCSF9TQ0hFRFVMRUQgfCBCSF9ERUxFVEVEKSkgPT0gQkhfU0NIRURVTEVE
KSB7CisgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CisgICAgICAgICAgICB9CisgICAgICAg
IH0KKyAgICB9CiAgICAgcmV0dXJuIGFpb19wZW5kaW5nKGN0eCkgfHwgKHRpbWVybGlzdGdyb3Vw
X2RlYWRsaW5lX25zKCZjdHgtPnRsZykgPT0gMCk7CiB9CiAKQEAgLTI2NSw2ICszMDMsOCBAQCBz
dGF0aWMgdm9pZAogYWlvX2N0eF9maW5hbGl6ZShHU291cmNlICAgICAqc291cmNlKQogewogICAg
IEFpb0NvbnRleHQgKmN0eCA9IChBaW9Db250ZXh0ICopIHNvdXJjZTsKKyAgICBRRU1VQkggKmJo
OworICAgIHVuc2lnbmVkIGZsYWdzOwogCiAgICAgdGhyZWFkX3Bvb2xfZnJlZShjdHgtPnRocmVh
ZF9wb29sKTsKIApAQCAtMjg3LDE4ICszMjcsMTUgQEAgYWlvX2N0eF9maW5hbGl6ZShHU291cmNl
ICAgICAqc291cmNlKQogICAgIGFzc2VydChRU0xJU1RfRU1QVFkoJmN0eC0+c2NoZWR1bGVkX2Nv
cm91dGluZXMpKTsKICAgICBxZW11X2JoX2RlbGV0ZShjdHgtPmNvX3NjaGVkdWxlX2JoKTsKIAot
ICAgIHFlbXVfbG9ja2NudF9sb2NrKCZjdHgtPmxpc3RfbG9jayk7Ci0gICAgYXNzZXJ0KCFxZW11
X2xvY2tjbnRfY291bnQoJmN0eC0+bGlzdF9sb2NrKSk7Ci0gICAgd2hpbGUgKGN0eC0+Zmlyc3Rf
YmgpIHsKLSAgICAgICAgUUVNVUJIICpuZXh0ID0gY3R4LT5maXJzdF9iaC0+bmV4dDsKKyAgICAv
KiBUaGVyZSBtdXN0IGJlIG5vIGFpb19iaF9wb2xsKCkgY2FsbHMgZ29pbmcgb24gKi8KKyAgICBh
c3NlcnQoUVNJTVBMRVFfRU1QVFkoJmN0eC0+Ymhfc2xpY2VfbGlzdCkpOwogCisgICAgd2hpbGUg
KChiaCA9IGFpb19iaF9kZXF1ZXVlKCZjdHgtPmJoX2xpc3QsICZmbGFncykpKSB7CiAgICAgICAg
IC8qIHFlbXVfYmhfZGVsZXRlKCkgbXVzdCBoYXZlIGJlZW4gY2FsbGVkIG9uIEJIcyBpbiB0aGlz
IEFpb0NvbnRleHQgKi8KLSAgICAgICAgYXNzZXJ0KGN0eC0+Zmlyc3RfYmgtPmRlbGV0ZWQpOwor
ICAgICAgICBhc3NlcnQoZmxhZ3MgJiBCSF9ERUxFVEVEKTsKIAotICAgICAgICBnX2ZyZWUoY3R4
LT5maXJzdF9iaCk7Ci0gICAgICAgIGN0eC0+Zmlyc3RfYmggPSBuZXh0OworICAgICAgICBnX2Zy
ZWUoYmgpOwogICAgIH0KLSAgICBxZW11X2xvY2tjbnRfdW5sb2NrKCZjdHgtPmxpc3RfbG9jayk7
CiAKICAgICBhaW9fc2V0X2V2ZW50X25vdGlmaWVyKGN0eCwgJmN0eC0+bm90aWZpZXIsIGZhbHNl
LCBOVUxMLCBOVUxMKTsKICAgICBldmVudF9ub3RpZmllcl9jbGVhbnVwKCZjdHgtPm5vdGlmaWVy
KTsKQEAgLTQ0NSw2ICs0ODIsOCBAQCBBaW9Db250ZXh0ICphaW9fY29udGV4dF9uZXcoRXJyb3Ig
KiplcnJwKQogICAgIEFpb0NvbnRleHQgKmN0eDsKIAogICAgIGN0eCA9IChBaW9Db250ZXh0ICop
IGdfc291cmNlX25ldygmYWlvX3NvdXJjZV9mdW5jcywgc2l6ZW9mKEFpb0NvbnRleHQpKTsKKyAg
ICBRU0xJU1RfSU5JVCgmY3R4LT5iaF9saXN0KTsKKyAgICBRU0lNUExFUV9JTklUKCZjdHgtPmJo
X3NsaWNlX2xpc3QpOwogICAgIGFpb19jb250ZXh0X3NldHVwKGN0eCk7CiAKICAgICByZXQgPSBl
dmVudF9ub3RpZmllcl9pbml0KCZjdHgtPm5vdGlmaWVyLCBmYWxzZSk7Ci0tIAoyLjI0LjEKCg==


